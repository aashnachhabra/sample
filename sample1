FROM docker.repo1.uhc.com/maven:3.8.6 AS builder
COPY . /usr/src/app
COPY settings.xml /root/.m2/settings.xml
WORKDIR /usr/src/app
# Using main POM
RUN mvn clean install -f pom.xml

FROM docker.repo1.uhc.com/tomcat:10-jdk17
ENV JAVA_OPTS="-Djasypt.encryptor.password=W4a!hXnhEc -Dspring.profiles.active=mac"
COPY --from=builder /usr/src/app/abb-web/target/classes/planlibrary.uhc.com.jks /usr/local/tomcat/lib/planlibrary.uhc.com.jks
COPY --from=builder /usr/src/app/abb-web/target/abb.war /usr/local/tomcat/webapps/abb.war
COPY --from=builder /usr/src/app/server.xml /usr/local/tomcat/conf

RUN chown -R 1001:0 /usr/local/tomcat/webapps/*
RUN chmod -R 777 /usr/local/tomcat/webapps/*

EXPOSE 443
CMD ["/usr/local/tomcat/bin/catalina.sh","run"]
