# Step 3: Get the files changed in the merged PR
- name: Fetch Changed Files
  id: changed-files
  run: |
    # Get the PR number
    PR_NUMBER=$(echo "${{ github.event.pull_request.number }}")
    
    # Define the base repository URL for constructing absolute paths
    REPO_URL="https://github.com/uhc-tech-employer-individual/altus_genie/blob/main"
    
    # Get the list of changed files with additions, deletions, and absolute paths
    FILES=$(gh pr view $PR_NUMBER --json files --jq "[.files[] | {path: .path, additions: .additions, deletions: .deletions}]")
    
    # Debug: Print the FILES variable
    echo "FILES: ${FILES}"
    
    # Determine the status of each file based on additions and deletions
    FILES_STATUS=$(echo "${FILES}" | jq -c '.[]' | while read -r file_info; do
      # Extract details
      FILE_PATH=$(echo "$file_info" | jq -r '.path')
      ADDITIONS=$(echo "$file_info" | jq -r '.additions')
      DELETIONS=$(echo "$file_info" | jq -r '.deletions')

      # Check if the file exists in the base branch (before merge)
      BASE_EXISTS=$(git ls-tree -r origin/main --name-only | grep -Fxq "$FILE_PATH" && echo "1" || echo "0")

      # Check if the file exists in the head branch (after merge)
      HEAD_EXISTS=$(git ls-tree -r HEAD --name-only | grep -Fxq "$FILE_PATH" && echo "1" || echo "0")

      # Determine file status
      if [[ "$BASE_EXISTS" -eq 0 && "$HEAD_EXISTS" -eq 1 ]]; then
        STATUS="added"
      elif [[ "$BASE_EXISTS" -eq 1 && "$HEAD_EXISTS" -eq 0 ]]; then
        STATUS="deleted"
      elif [[ "$BASE_EXISTS" -eq 1 && "$HEAD_EXISTS" -eq 1 ]]; then
        STATUS="modified"
      else
        STATUS="unknown"
      fi

      # Construct JSON output
      echo "{\"path\": \"$FILE_PATH\", \"additions\": $ADDITIONS, \"deletions\": $DELETIONS, \"status\": \"$STATUS\"}"
    done | jq -s '.')

    # Save JSON output
    echo "${FILES_STATUS}" > changed_files.json
    echo "::set-output name=files::${FILES_STATUS}"

