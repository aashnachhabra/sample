<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
    <%@taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
       <%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %>
          <!doctype html>
          <html>

          <head>
             <meta charset="utf-8">
             <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
             <link rel="stylesheet" href="css/UHCcustom.css">
             <link rel="stylesheet" href="css/bootstrap.css">
             <link rel="stylesheet" href="css/css/fontawesome.min.css">
             <link rel="stylesheet" href="css/css/brands.min.css">
             <link rel="stylesheet" href="css/css/solid.min.css">
             <link rel="stylesheet" href="css/loader.css">
             <link href="https://unpkg.com/frappe-datatable@1.16.2/dist/frappe-datatable.min.css" rel="stylesheet">
             <link rel="stylesheet" href="css/plan-management.css">
             <script src="js/jquery-3.3.1.min.js"></script>
             <script src="js/popper.min.js"></script>
             <script src="js/UHCcustom.js"></script>
             <script src="js/bootstrap.min.js"></script>
             <script src="js/loader.js"></script>
             <!-- include the dependencies -->
             <script src="https://unpkg.com/sortablejs@1.7.0/Sortable.min.js"></script>
             <script src="https://unpkg.com/clusterize.js@0.18.0/clusterize.min.js"></script>
             <!-- include the lib -->
             <script src="js/frappe-datatable.min.js"></script>
             <script src="js/app/planManagement.js"></script>
             <title>Plan Management</title>
             <link rel="icon" href="assets/PlanBuilderFavIcon.png">
             <script>
                $(function () {
                   $('[data-toggle="tooltip"]').tooltip()
                })
             </script>
             <style>
                .dropdown-menu.show {
                   max-height: 200px;
                   overflow-y: auto;
                }
             </style>
          </head>

          <body>
             <%@include file="loader.jsp" %>
                <%@include file="header.jsp" %>
                   <div class="text-primary" style="margin: 2em;">
                      <h1><i class="fa-solid fa-code-compare"></i> Plan Management</h1>
                   </div>
                   <div class="shadow-lg p-3 mb-5 bg-white rounded" style="margin:2em">
                      <!--  <form> -->
                      <div class="row">
                         <div class="col">
                            <div class="form-floating">
                               <input type="text" class="form-control" id="planCode" placeholder="ABCD">
                               <label for="planCode" class="form-label">Plan Code</label>
                            </div>
                         </div>
                         <div class="col">
                            <div class="form-floating">
                               <input type="text" class="form-control" id="productID" placeholder="ABCD">
                               <label for="productID" class="form-label">Product ID</label>
                            </div>
                         </div>
                         <div class="col">
                            <div class="form-floating">
                               <input type="text" class="form-control" id="hiosID" placeholder="NA">
                               <label for="hiosID" class="form-label">HIOS ID</label>
                            </div>
                         </div>
                      </div>
                      <div class="row" style="margin-top: 1em;">
                         <div class="col">
                            <div class="form-floating">
                               <input type="text" class="form-control" list="states" id="state"
                                  placeholder="ABCD">
                               <label for="state" class="form-label">State</label>
                               <datalist id="states">
                                  <c:forEach var="state" items="${planDD.stateMap}">
                                     <option id="${state.key}" name="${state.key}">${state.key}</option>
                                  </c:forEach>
                               </datalist>
                            </div>
                         </div>

                         <div class="col">
                            <div class="form-floating">
                               <input type="text" class="form-control" list="COCs" id="cocSeries"
                                  placeholder="1992">
                               <label for="cocSeries" class="form-label">COC Series</label>
                               <datalist id="COCs">
                                  <c:forEach var="coc" items="${planDD.cocSeriesMap}">
                                     <option id="${coc.key}" name="${coc.value}">${coc.value}</option>
                                  </c:forEach>
                               </datalist>
                            </div>
                         </div>

                         <div class="col">
                            <div class="form-floating">
                               <input type="text" class="form-control" list="productFamily"
                                  id="productFamilies" placeholder="1992">
                               <label for="productFamilies" class="form-label">Product Family</label>
                               <datalist id="productFamily">
                                  <c:forEach var="product" items="${planDD.productMap}">
                                     <option id="${product.key}" name="${product.value}">${product.value}
                                     </option>
                                  </c:forEach>
                               </datalist>
                            </div>
                         </div>
                      </div>
                      <div class="row" style="margin-top: 1em;">
                         <div class="col">
                            <div class="d-grid gap-2">
                               <button role="button" class="btn btn-outline-success" id="Generate"
                                  onClick="validateGenerate()" disabled=true><i
                                     class="fa-solid fa-arrows-spin"></i> Generate</button>
                            </div>
                         </div>
                         <div class="col">
                            <div class="d-grid gap-2">
                               <button type="button" class="btn btn-outline-warning" id="Publish"
                                  onClick="validatePublish()" disabled=true><i class="fas fa-upload"></i>
                                  Publish</button>
                            </div>
                         </div>
                         <div class="col">
                            <div class="d-grid gap-2">
                               <button type="button" class="btn btn-outline-primary"
                                  onclick="getSearchData();"><i class="fas fa-search"></i> Search</button>
                            </div>
                         </div>
                      </div>
                      <!--  </form> -->
                      <div id="datatable" style="margin-top: 1em;display: none"></div>
                      <div id="noResult" style="display: none"><br>
                         <p class="text-center">No search results returned. Please update your search criteria,
                            then try again.</p>
                      </div>
                   </div>
                   <%@include file="footer.html" %>
                      <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel"
                         aria-hidden="true">
                         <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                               <div class="modal-header">
                                  <h5><span id="ErrorClose" class="modal-title text-danger">Error</span></h5>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal"
                                     aria-label="Close"></button>
                               </div>
                               <div class="modal-body"
                                  style="overflow: auto; overflow-wrap: break-word; width: 30em; max-height: 20em;">
                                  <p>
                                     <span id="ErrorMesssage"></span>
                                     <input type="hidden" name="ctl00$MainContent$hfBatchTypes" value="0"
                                        autocomplete="off">
                                  </p>
                               </div>
                               <div class="modal-footer">
                                  <input type="submit" name="ctl00$MainContent$btnLGClose" value="Cancel"
                                     id="errorModalClose" class="btn btn-outline-danger"
                                     data-bs-dismiss="modal" autocomplete="off">
                               </div>
                            </div>
                         </div>
                      </div>
                      <div class="modal fade" id="generateCfrmBoxModal" tabindex="-1" role="dialog"
                         aria-labelledby="generateCfrmModalLabel" aria-hidden="true">
                         <div class="modal-dialog modal-dialog-centered" role="document">
                            <div class="modal-content">
                               <div class="modal-header">
                                  <h5>
                                     <span id="lblWarnTitle" class="modal-title text-danger">
                                        Warning </span>
                                  </h5>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal"
                                     aria-label="Close"></button>
                               </div>
                               <div class="modal-body">Please confirm that you'd like to
                                  generate a batch for the selected plan(s)?

                                  <div class="container mt-5">
                                     <div class="mb-3">
                                        <label for="multiSelectInput" class="form-label">Select
                                           Region</label>
                                        <input type="text" class="form-control" id="multiSelectInput"
                                           list="regions" placeholder="Type to search regions...">
                                        <datalist id="regions">
                                           <c:forEach var="reg" items="${planMngDDMap.regionMap}">
                                              <option id="${reg.key}" name="${reg.value}"
                                                 value="${reg.value}">${reg.value}
                                              </option>
                                           </c:forEach>
                                        </datalist>
                                     </div>
                                     <div id="selectedItems" class="mt-2">
                                        <!-- Selected items will appear here -->
                                     </div>
                                  </div>

                                  <div class="modal-footer">
                                     <%-- name="ctl00$MainContent$btnLGClose" --%>
                                        <input type="submit" value="Cancel" id="generateClose"
                                           class="btn btn-outline-danger" data-bs-dismiss="modal"
                                           autocomplete="off"> <a onclick="generateBatch();"
                                           id="generateConfirm" class="btn btn-outline-success"
                                           data-dismiss="modal">Send</a>
                                  </div>
                               </div>
                            </div>
                         </div>
                         <div class="modal fade" id="publishCfrmBoxModal" tabindex="-1" role="dialog"
                            aria-labelledby="publishCfrmModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                               <div class="modal-content">
                                  <div class="modal-header">
                                     <h5>
                                        <span id="lblWarnTitle" class="modal-title text-danger">
                                           Warning </span>
                                     </h5>
                                     <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                  </div>
                                  <div class="modal-body">Please confirm that you'd like to
                                     publish a batch for the selected plan(s)?</div>
                                  <div class="modal-footer">
                                     <%-- name="ctl00$MainContent$btnLGClose" --%>
                                        <input type="submit" value="Cancel" id="publishClose"
                                           class="btn btn-outline-danger" data-bs-dismiss="modal"
                                           autocomplete="off"> <a onclick="publishBatch();"
                                           id="publishConfirm" class="btn btn-outline-success"
                                           data-dismiss="modal">Confirm</a>
                                  </div>
                               </div>
                            </div>
                         </div>
                         <div style="position: fixed; top:80%; right:40%; width:31%; z-index:1;" class="toast" ;
                            position-class="toast-top-full-width" ; data-autohide="false" id="success">
                            <!--bottom: 50%;right:40%;-->
                            <div class="toast-header">
                               <strong class="mr-auto text-primary"> <i class="fas fa-square"
                                     style="color:#00a550"></i> Generate/Publish Plan</strong>
                               <button type="button" style="margin-left: auto;" class="btn-close"
                                  data-bs-dismiss="toast"></button>
                            </div>
                            <div class="toast-body" style="background-color: #E8E8E8" id="successMessage"></div>
                         </div>
                         <script>

                            document.addEventListener('DOMContentLoaded', function () {
                                        var selectedIds=[]

                               const multiSelectInput = document.getElementById('multiSelectInput');

                               const selectedItemsContainer = document.getElementById('selectedItems');

                               multiSelectInput.addEventListener('change', function () {
console.log(multiSelectInput)
                                  const value = multiSelectInput.value;
const key = multiSelectInput.id;
console.log(key)
                                  if (value) {

                                     addSelectedItem(value);

                                     multiSelectInput.value = '';

                                  }

                               });

                               function addSelectedItem(value) {

                                  const existingItems = Array.from(selectedItemsContainer.children).map(item => item.textContent.trim());
                                  selectedIds.push(value)
                            
                                  if (!existingItems.includes(value)) {

                                     const itemBadge = document.createElement('span');

                                     itemBadge.className = 'badge bg-primary me-2';

                                     itemBadge.textContent = value;

                                     const removeBtn = document.createElement('button');

                                     removeBtn.className = 'btn-close ms-1';

                                     removeBtn.setAttribute('aria-label', 'Remove');

                                     removeBtn.addEventListener('click', function () {

                                        selectedItemsContainer.removeChild(itemBadge);

                                     });

                                     itemBadge.appendChild(removeBtn);
console.log(itemBadge)
                                     selectedItemsContainer.appendChild(itemBadge);
console.log(selectedItemsContainer);
                                  }

                               }

                            });

                         </script>
          </body>

          </html>
