package com.optum.ideate.controller; import com.amazonaws.util.IOUtils; import com.mongodb.client.result.UpdateResult; import com.optum.ideate.api.request.v1.DropdownOption; import com.optum.ideate.aspose.Constants; import com.optum.ideate.constants.SessionConstants; import com.optum.ideate.model.request.*; import com.optum.ideate.model.response.MaximumChangedSearchResponse; import com.optum.ideate.model.response.MaximumManagementNoteResponse; import com.optum.ideate.model.response.MaximumMgmtDDMapResponse; import com.optum.ideate.model.response.PlanAssignmentRequest; import com.optum.ideate.mongodb.domain.MasterBenefitCategoryCollection; import com.optum.ideate.mongodb.domain.MaxMgmtProcessLog; import com.optum.ideate.mongodb.domain.MaximumManagementCollection; import com.optum.ideate.mongodb.domain.PlIFPDropdowns; import com.optum.ideate.mongodb.repo.MaxMgmtProcessLogRepository; import com.optum.ideate.mongodb.domain.PortfolioEditorDropDownCollection; import com.optum.ideate.mongodb.repo.MaximumManagementCollectionRepository; import com.optum.ideate.mongodb.repo.PlIFPDropdownsRepository; import com.optum.ideate.mongodb.repo.PortfolioEditorDropDownRepository; import com.optum.ideate.service.MaximumManagementService; import com.optum.ideate.service.ProductManagmentService; import com.optum.ideate.util.MaximumTrackPlanUpdates; import com.optum.ideate.utils.ErrorUtil; import jakarta.servlet.http.HttpServletResponse; import lombok.SneakyThrows; import org.apache.commons.collections4.CollectionUtils; import org.apache.commons.lang3.ObjectUtils; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.beans.factory.annotation.Qualifier; import org.springframework.data.mongodb.core.MongoTemplate; import org.springframework.data.mongodb.core.query.Criteria; import org.springframework.data.mongodb.core.query.Query; import org.springframework.data.mongodb.core.query.Update; import org.springframework.http.*; import org.springframework.stereotype.Controller; import org.springframework.web.bind.annotation.*; import org.springframework.web.bind.support.DefaultSessionAttributeStore; import org.springframework.web.context.request.WebRequest; import org.springframework.web.servlet.ModelAndView; import org.apache.commons.lang3.StringUtils; import com.optum.ideate.model.request.MaximumManagementNoteRequest; import com.optum.ideate.mongodb.domain.MaximumManagementNotesCollection; import jakarta.servlet.http.HttpServletRequest; import jakarta.servlet.http.HttpSession; import java.io.ByteArrayInputStream; import java.io.IOException; import java.util.*; import java.util.stream.Collectors; @Controller public class MaximumManagementController { @Autowired @Qualifier("mongoTemplate") private MongoTemplate mongoTemplate; @Autowired private PortfolioEditorDropDownRepository portfolioEditorDropDownRepository; @Autowired MaximumManagementCollectionRepository repo; @Autowired private ProductManagmentService productManagmentService; @Autowired MaximumManagementCollectionRepository maximumRepo; @Autowired MaximumManagementService maximumManagementService; @Autowired PlIFPDropdownsRepository plIFPDropdownsRepository; @Autowired MaxMgmtProcessLogRepository maxMgmtProcessLogRepository; private final static Logger logger = LoggerFactory.getLogger(MaximumManagementController.class); @GetMapping("/maxManagement") public ModelAndView maximumManagement(ModelAndView modelAndView, HttpServletRequest request) { try { modelAndView.setViewName("MaximumManagement"); MaximumMgmtDDMapResponse maximumMgmtDDMapResponse; MaximumMgmtDDMapResponse maximumMgmtDDMapResponseForIEX; HttpSession session = request.getSession(); maximumMgmtDDMapResponse = maximumManagementService.getMaximumMgmtDropDownsMap(); maximumMgmtDDMapResponseForIEX = maximumManagementService.getMaximumMgmtDropDownsForIEXOrg(); maximumMgmtDDMapResponse.getStandardMap().clear(); maximumMgmtDDMapResponse.getStandardMap().putAll(maximumMgmtDDMapResponseForIEX.getStandardMap()); session.setAttribute("maximumMngDDMap", maximumMgmtDDMapResponse); modelAndView.addObject("maximumDD", maximumMgmtDDMapResponse); modelAndView.addObject("allMaxData", Collections.emptyList()); modelAndView.addObject("maxManagementSearchResponse", Collections.emptyMap()); modelAndView.addObject("maxManagementSearchRequest", null); session.setAttribute("maxManagementSearchRequest", null); List<MasterBenefitCategoryCollection> benefitCategoryList = productManagmentService.getMasterBenefitCategoryCollection(); List<String> benefitCategoryNames = new ArrayList<>(); if (CollectionUtils.isNotEmpty(benefitCategoryList)) { benefitCategoryList.stream().forEach(bcl -> benefitCategoryNames.add(bcl.getBenefitCategoryValue())); } benefitCategoryNames.sort(Comparator.naturalOrder()); modelAndView.addObject(Constants.BEN_CAT_NAMES, benefitCategoryNames); List<String> limitTypes = Constants.limitType; List<String> frequencyTypes = Constants.frequencyType; List<String> appliesTo = maximumManagementService.findAllAppliesTo(null); limitTypes.remove(" "); modelAndView.addObject(Constants.LIMIT_TYPES, limitTypes); frequencyTypes.remove(" "); modelAndView.addObject(Constants.FREQUENCY_TYPES, frequencyTypes); appliesTo.remove(" "); modelAndView.addObject(Constants.APPLIES_TO, appliesTo); List<String> crossApplies = Constants.crossApplies; crossApplies.remove(" "); modelAndView.addObject(Constants.CROSS_APPLIES, crossApplies); List<String> visible = Constants.visible; visible.remove(" "); modelAndView.addObject(Constants.VISIBLE, visible); List<String> status = Constants.status; status.remove(" "); modelAndView.addObject(Constants.STATUS, status); List<String> subCategory = Constants.subCategory; modelAndView.addObject(Constants.SUBCATEGORY, subCategory); String currentUserID = (String) session.getAttribute(SessionConstants.USER_NAME); String currentUserEmail = (String) session.getAttribute(SessionConstants.USER_EMAIL); modelAndView.addObject("optOption", maximumManagementService.isOptIn(currentUserID, currentUserEmail)); return modelAndView; } catch (Exception exception) { return ErrorUtil.validateErrorMessage(exception); } } private String buildGroupKey(MaximumManagementCollection m) { String benCat = safeString(m.getBenCatName()); String coc = m.getCocSeries() == null ? "" : String.valueOf(m.getCocSeries()).trim().toLowerCase(); String state = safeString(m.getState()); String standard = safeString(m.getStandard()); return String.join("_", benCat, coc, state, standard); } private String safeString(String s) { return s == null ? "" : s.trim().toLowerCase(); } private String sanitizeForLog(String input) { if (input == null) { return null; } return input.replace('\n', ' ').replace('\r', ' '); } @GetMapping("/maxManagement/get-notes") @ResponseBody public List<Map<String, Object>> getNotes( @RequestParam String benCatName, @RequestParam Long cocSeries, @RequestParam String state, @RequestParam String standard) { return maximumManagementService.getNotes(benCatName, cocSeries, state, standard); } @PostMapping("/maxManagement/save-notes") @ResponseBody public ResponseEntity<MaximumManagementNoteResponse> saveNote( @RequestBody MaximumManagementNoteRequest noteRequest, HttpServletRequest request) { HttpSession session = request.getSession(); String currentUser = (String) session.getAttribute(SessionConstants.USER_NAME); return maximumManagementService.saveNote(noteRequest, currentUser); } @GetMapping("/maxManagement/all-product-family") @ResponseBody public List<String> getAllPortfolioManagementProductFamily() { MaximumMgmtDDMapResponse maximumMgmtDDMapResponseForIEX; maximumMgmtDDMapResponseForIEX = maximumManagementService.getMaximumMgmtDropDownsForIEXOrg(); return maximumMgmtDDMapResponseForIEX.getStandardMap().values().stream() .sorted() .collect(Collectors.toList()); } @GetMapping("/maxManagement/subcategory-by-appliesTo") @ResponseBody public String getSubCategoryByAppliesTo( @RequestParam String cocSeries, @RequestParam String appliesTo) { try { PlIFPDropdowns plIFPDropdowns = plIFPDropdownsRepository.findByCocSeriesAndIsCurrent(Integer.parseInt(cocSeries.trim()), 1); if (plIFPDropdowns != null && plIFPDropdowns.getAppliesTo() != null) { for (DropdownOption option : plIFPDropdowns.getAppliesTo()) { if (option.getIsCurrent() != null && option.getIsCurrent() == 1 && option.getName() != null && option.getName().equals(appliesTo)) { String subCategory = option.getSubCategory(); if (StringUtils.isNotEmpty(subCategory)) { return subCategory; } break; } } } return Constants.appliesToSubCategoryMap.getOrDefault(appliesTo, ""); } catch (Exception e) { logger.error("Error fetching subcategory for appliesTo '{}': {}", sanitizeForLog(appliesTo), e.getMessage()); return Constants.appliesToSubCategoryMap.getOrDefault(appliesTo, ""); } } @PostMapping("/maxManagementSearch") public ModelAndView getMaximumSearchData(@ModelAttribute PlanAssignmentRequest planAssignmentRequest, WebRequest request, HttpServletRequest httpServletRequest) { ModelAndView modelAndView = new ModelAndView(); Integer isCurrent = 1; DefaultSessionAttributeStore session = new DefaultSessionAttributeStore(); if (session.retrieveAttribute(request, "maxManagementSearchRequest") == null) { session.storeAttribute(request, "maxManagementSearchRequest", planAssignmentRequest); } MaximumMgmtDDMapResponse maximumMgmtDDMapResponse; if (session.retrieveAttribute(request, "maximumMngDDMap") == null) { maximumMgmtDDMapResponse = maximumManagementService.getMaximumMgmtDropDownsMap(); session.storeAttribute(request, "maximumMngDDMap", maximumMgmtDDMapResponse); } else { maximumMgmtDDMapResponse = (MaximumMgmtDDMapResponse) session.retrieveAttribute(request, "maximumMngDDMap"); } PlIFPDropdowns plIFPDropdowns = null; String cocSeries = planAssignmentRequest.getCoc(); TreeMap<String, String> productFamilyTreeMap = new TreeMap<>(); if (StringUtils.isNotEmpty(cocSeries)) { if (cocSeries.contains(",")) { String[] arrOfStr = cocSeries.split(","); for (String coc : arrOfStr) { plIFPDropdowns = plIFPDropdownsRepository.findByCocSeriesAndIsCurrent(Integer.parseInt(coc.trim()), isCurrent); if (ObjectUtils.isNotEmpty(plIFPDropdowns) && ObjectUtils.isNotEmpty(plIFPDropdowns.getProductFamily()) && ObjectUtils.isNotEmpty(maximumMgmtDDMapResponse)) { plIFPDropdowns.getProductFamily() .stream() .filter(e -> e.getIsCurrent() == 1) .forEach(item -> productFamilyTreeMap.put(item.getName(), item.getName())); } } } else { plIFPDropdowns = plIFPDropdownsRepository.findByCocSeriesAndIsCurrent(Integer.parseInt(cocSeries.trim()), isCurrent); if (ObjectUtils.isNotEmpty(plIFPDropdowns) && ObjectUtils.isNotEmpty(plIFPDropdowns.getProductFamily()) && ObjectUtils.isNotEmpty(maximumMgmtDDMapResponse)) { plIFPDropdowns.getProductFamily() .stream() .filter(e -> e.getIsCurrent() == 1) .forEach(item -> productFamilyTreeMap.put(item.getName(), item.getName())); } } maximumMgmtDDMapResponse.setStandardMap(productFamilyTreeMap); } else { PortfolioEditorDropDownCollection portfolioEditorDropDownCollection = portfolioEditorDropDownRepository.findByPageName("Portfolio Editor"); portfolioEditorDropDownCollection.getProductFamily() .stream() .map(DropdownOption::getName) .forEach(item -> productFamilyTreeMap.put(item, item)); maximumMgmtDDMapResponse.setStandardMap(productFamilyTreeMap); } modelAndView.addObject("maximumDD", maximumMgmtDDMapResponse); List<MaximumManagementCollection> maximumList = maximumManagementService.getMaxSearchData(planAssignmentRequest); List<MaximumManagementCollection> filteredDeletedMaximumList = maximumList.stream().filter (e -> e.getStatus().equals(Constants.currentDeleted)).collect(Collectors.toList()); List<MaximumManagementCollection> filteredMaximumList = maximumList.stream().filter (e -> e.getStatus().equals(Constants.active)).collect(Collectors.toList()); modelAndView.addObject("enabledCascade", false); if (!filteredMaximumList.isEmpty()) { filteredMaximumList.forEach(request1 -> { if (request1.isBulkCascadeRequired()) { modelAndView.addObject("enabledCascade", true); } }); } List<MaximumManagementCollection> filteredCurrentDeletedList = maximumList.stream().filter (e -> e.getStatus().equals(Constants.currentDeleted)).collect(Collectors.toList()); if (!filteredCurrentDeletedList.isEmpty()) { filteredCurrentDeletedList.forEach(request1 -> { updateStatus(request1.getMaxId().intValue(), Constants.deleted); modelAndView.addObject("enabledCascade", true); }); } modelAndView.addObject("allMaxData", filteredMaximumList); modelAndView.setViewName("MaximumManagement"); modelAndView.addObject("maxManagementSearchRequest", planAssignmentRequest); Map<String, List<MaximumManagementCollection>> groupedByKey = filteredMaximumList.stream() .collect(Collectors.groupingBy( this::buildGroupKey, LinkedHashMap::new, Collectors.toList() )); modelAndView.addObject("maxManagementSearchResponse",groupedByKey); List<MasterBenefitCategoryCollection> benefitCategoryList = productManagmentService.getMasterBenefitCategoryCollection(); List<String> benefitCategoryNames = new ArrayList<>(); if (CollectionUtils.isNotEmpty(benefitCategoryList)) { benefitCategoryList.stream().forEach(bcl -> benefitCategoryNames.add(bcl.getBenefitCategoryValue())); } benefitCategoryNames.sort(Comparator.naturalOrder()); modelAndView.addObject(Constants.BEN_CAT_NAMES, benefitCategoryNames); List<String> limitTypes = Constants.limitType; List<String> frequencyTypes = Constants.frequencyType; if (plIFPDropdowns != null) { limitTypes = plIFPDropdowns.getLimitType() != null ? plIFPDropdowns.getLimitType() .stream().filter(e -> e.getIsCurrent() == 1) .map(DropdownOption::getName) .collect(Collectors.toList()) : Constants.limitType; frequencyTypes = plIFPDropdowns.getFrequencyType() != null ? plIFPDropdowns.getFrequencyType() .stream().filter(e -> e.getIsCurrent() == 1) .map(DropdownOption::getName) .collect(Collectors.toList()) : Constants.frequencyType; } limitTypes.remove(" "); modelAndView.addObject(Constants.LIMIT_TYPES, limitTypes); frequencyTypes.remove(" "); modelAndView.addObject(Constants.FREQUENCY_TYPES, frequencyTypes); String cocSeriesForDropdown = planAssignmentRequest.getCoc(); List<String> appliesTo = maximumManagementService.findAllAppliesTo(cocSeriesForDropdown); List<String> crossApplies = Constants.crossApplies; crossApplies.remove(" "); modelAndView.addObject(Constants.CROSS_APPLIES, crossApplies); List<String> visible = Constants.visible; visible.remove(" "); modelAndView.addObject(Constants.VISIBLE, visible); List<String> status = Constants.status; status.remove(" "); modelAndView.addObject(Constants.STATUS, status); List<String> subCategory = Constants.subCategory; modelAndView.addObject(Constants.SUBCATEGORY, subCategory); HttpSession httpSession = httpServletRequest.getSession(); String currentUserID = (String) httpSession.getAttribute(SessionConstants.USER_NAME); String currentUserEmail = (String) httpSession.getAttribute(SessionConstants.USER_EMAIL); modelAndView.addObject("optOption", maximumManagementService.isOptIn(currentUserID, currentUserEmail)); return modelAndView; } @PostMapping("/saveNewMaximum") @ResponseBody @SneakyThrows public ResponseEntity<Object> saveNewMaximum(HttpServletRequest request, @RequestBody MaximumManagementCollection managementCollection) { HttpSession session = request.getSession(); String currentUser = (String) session.getAttribute(SessionConstants.USER_NAME); MaximumTrackPlanUpdates.setCurrentUser(currentUser); try { MaximumManagementCollection max = maximumRepo.findTopByOrderByMaxIdDesc(); Long maxIdVal = max.getMaxId(); logger.info("MaximumManagementController :: saveNewMaximum() maxIdVal : " + maxIdVal); logger.info("MaximumManagementController :: saveNewMaximum() subCategory received: " + managementCollection.getSubCategory()); if (managementCollection.getMaxId() == null) { PlanAssignmentRequest planAssignmentRequest = toPlanAssignmentRequest(managementCollection); List<MaximumManagementCollection> maximumList = maximumManagementService.getMaxSearchData(planAssignmentRequest); List<MaximumManagementCollection> duplicateAppliesTo = maximumList.stream() .filter(e -> e.getStatus().equals(Constants.active) && e.getAppliesTo().equalsIgnoreCase(managementCollection.getAppliesTo())) .collect(Collectors.toList()); if (!duplicateAppliesTo.isEmpty()) { return ResponseEntity.status(HttpStatus.CREATED).body(Collections.singletonMap("newMaximums", 0)); } logger.info("No duplicate found - saving new maximum"); managementCollection.setMaxId(maxIdVal + 1); managementCollection.setStatus(Constants.active); managementCollection.setBulkCascadeRequired(true); maximumRepo.save(managementCollection); try { List<MaxMgmtProcessLog> maxMgmtProcessLogs = MaximumTrackPlanUpdates.populateDifferences(null, managementCollection); if (maxMgmtProcessLogs != null && !maxMgmtProcessLogs.isEmpty()) { maxMgmtProcessLogs.forEach(maxMgmtProcessLog -> maxMgmtProcessLogRepository.save(maxMgmtProcessLog)); logger.info("Created " + maxMgmtProcessLogs.size() + " log records for new maximum with maxId: " + managementCollection.getMaxId()); } } catch (Exception e) { logger.error("Error logging new maximum creation for maxId: " + managementCollection.getMaxId(), e); } } else { updatePlanStatus(managementCollection); } return ResponseEntity.status(HttpStatus.CREATED).body(Collections.singletonMap("newMaximums", 1)); } catch (Exception e) { logger.error("Error in saveNewMaximum", e); throw e; } } private PlanAssignmentRequest toPlanAssignmentRequest(MaximumManagementCollection managementCollection) { PlanAssignmentRequest request = new PlanAssignmentRequest(); request.setAppliesTo(managementCollection.getAppliesTo()); request.setBenCatName(managementCollection.getBenCatName()); request.setStandard(managementCollection.getStandard()); request.setStateName(managementCollection.getState()); request.setCoc(managementCollection.getCocSeries().toString()); return request; } public Long updatePlanStatus(MaximumManagementCollection managementCollection) { try { MaximumManagementCollection existingCollection = maximumRepo.findByMaxId(managementCollection.getMaxId()); if (existingCollection != null) { List<MaxMgmtProcessLog> maxMgmtProcessLogs = MaximumTrackPlanUpdates.populateDifferences(existingCollection, managementCollection); if (maxMgmtProcessLogs != null && !maxMgmtProcessLogs.isEmpty()) { maxMgmtProcessLogs.forEach(maxMgmtProcessLog -> maxMgmtProcessLogRepository.save(maxMgmtProcessLog)); logger.info("Created " + maxMgmtProcessLogs.size() + " log records for updated maximum with maxId: " + managementCollection.getMaxId()); } } } catch (Exception e) { // Log the error but don't fail the update logger.error("Error tracking changes for maxId: " + managementCollection.getMaxId(), e); } Query query = new Query(); query.addCriteria(Criteria.where("maxId").is(managementCollection.getMaxId())); Update update = new Update(); if (null != managementCollection.getBenCatName()) { update.set(Constants.BEN_CAT_NAME, managementCollection.getBenCatName()); } if (null != managementCollection.getCocSeries()) { update.set(Constants.COC_SERIES, managementCollection.getCocSeries()); } if (null != managementCollection.getState()) { update.set(Constants.STATE, managementCollection.getState()); } if (null != managementCollection.getStandard()) { update.set(Constants.STANDARD, managementCollection.getStandard()); } if (null != managementCollection.getAppliesTo()) { update.set(Constants.APPLIES_TO, managementCollection.getAppliesTo()); } if (null != managementCollection.getCrossApplies()) { update.set(Constants.CROSS_APPLIES, managementCollection.getCrossApplies()); } if (null != managementCollection.getMaxType()) { update.set(Constants.MAX_TYPE, managementCollection.getMaxType()); } if (null != managementCollection.getMaxValue()) { update.set(Constants.MAX_VAL, managementCollection.getMaxValue()); } if (null != managementCollection.getFreqType()) { update.set(Constants.FREQ_TYPE, managementCollection.getFreqType()); } update.set(Constants.FREQ_VAL, managementCollection.getFreqValue()); if (null != managementCollection.getVisible()) { update.set(Constants.VISIBLE, managementCollection.getVisible()); } if (null != managementCollection.getSubCategory()) { update.set(Constants.SUBCATEGORY, managementCollection.getSubCategory()); } if(null != managementCollection.getMaximumStatus()) { update.set(Constants.MAXIMUM_STATUS, managementCollection.getMaximumStatus()); } update.set("isBulkCascadeRequired", true); UpdateResult result; try { result = mongoTemplate.updateFirst(query, update, MaximumManagementCollection.class); } catch (Exception e) { throw new RuntimeException("Couldn't update the data for maxId: " + managementCollection.getMaxId(), e); } return result.getModifiedCount(); } @PostMapping("/deleteParentMaximum") public ResponseEntity<String> deleteParentMaximum(HttpServletRequest request, @RequestBody ParentMaximumRequest requestBody) { HttpSession session = request.getSession(); String currentUser = (String) session.getAttribute(SessionConstants.USER_NAME); return maximumManagementService.deleteParentMaximum(requestBody, currentUser); } @PostMapping("/bulkDeleteParentMaximum") public ResponseEntity<String> bulkDeleteParentMaximum(HttpServletRequest request, @RequestBody List<Integer> maxIds) { HttpSession session = request.getSession(); String currentUser = (String) session.getAttribute(SessionConstants.USER_NAME); return maximumManagementService.deleteParentMaximumByIds(maxIds, currentUser); } @PostMapping("/deletePlanConfirm") @ResponseBody @SneakyThrows public ResponseEntity<Object> deletePlanConfirm(HttpServletRequest request, @RequestBody Integer maxIdVal) { HttpSession session = request.getSession(); String currentUser = (String) session.getAttribute(SessionConstants.USER_NAME); MaximumTrackPlanUpdates.setCurrentUser(currentUser); try { MaximumManagementCollection existingCollection = maximumRepo.findByMaxId(Long.valueOf(maxIdVal)); if (existingCollection != null) { List<MaxMgmtProcessLog> deletionLogs = MaximumTrackPlanUpdates.populateDeletionLog(existingCollection, true); if (deletionLogs != null && !deletionLogs.isEmpty()) { deletionLogs.forEach(log -> maxMgmtProcessLogRepository.save(log)); logger.info("Created " + deletionLogs.size() + " deletion log records for maxId: " + maxIdVal); } } } catch (Exception e) { logger.error("Error logging deletion for maxId: " + maxIdVal, e); } updateStatus(maxIdVal, Constants.currentDeleted); updateIsBulkCascadeRequired(maxIdVal, true); return ResponseEntity.status(HttpStatus.CREATED).body(Collections.singletonMap("deleteMaximums", 1)); } public Long updateIsBulkCascadeRequired(Integer maxId, boolean isBulkCascadeRequired) { Query query = new Query(); query.addCriteria(Criteria.where("maxId").is(maxId)); Update update = new Update(); update.set("isBulkCascadeRequired", isBulkCascadeRequired); UpdateResult result; try { result = mongoTemplate.updateFirst(query, update, MaximumManagementCollection.class); } catch (Exception e) { throw new RuntimeException("Couldn't update the data for maxId: " + maxId, e); } return result.getModifiedCount(); } public Long updateStatus(Integer maxId, String statusMessage) { Query query = new Query(); query.addCriteria(Criteria.where("maxId").is(maxId)); Update update = new Update(); update.set("status", statusMessage); UpdateResult result; try { result = mongoTemplate.updateFirst(query, update, MaximumManagementCollection.class); } catch (Exception e) { throw new RuntimeException("Couldn't update the data for maxId: " + maxId, e); } return result.getModifiedCount(); } @PostMapping("/copyParentAndChildren") @ResponseBody @SneakyThrows public ResponseEntity<Object> copyParentAndChildren( HttpServletRequest request, @RequestBody List<CopyParentChildRequest> copyRequests) { HttpSession session = request.getSession(); String currentUser = (String) session.getAttribute(SessionConstants.USER_NAME); MaximumTrackPlanUpdates.setCurrentUser(currentUser); List<Long> newIds = maximumManagementService.copyParentAndChildren(copyRequests, currentUser); return ResponseEntity.status(HttpStatus.CREATED) .body(Collections.singletonMap("copiedMaxIds", newIds)); } @PostMapping("/isBenCatExistForNewMaximumMgmt") @ResponseBody public ResponseEntity<Object> checkNewMaximumMgmtDataExist(@RequestBody MaximumManagementCollection managementCollection, HttpServletRequest request) { HttpSession session = request.getSession(); MaximumMgmtDDMapResponse maximumMgmtDDMapResponse; if (session.getAttribute("maximumMngDDMap") == null) { maximumMgmtDDMapResponse = maximumManagementService.getMaximumMgmtDropDownsMap(); session.setAttribute("maximumMngDDMap", maximumMgmtDDMapResponse); } else { maximumMgmtDDMapResponse = (MaximumMgmtDDMapResponse) session.getAttribute("maximumMngDDMap"); } PlanAssignmentRequest planAssignmentRequest = toPlanAssignmentRequest(managementCollection); List<MaximumManagementCollection> maximumList = maximumManagementService.getMaxSearchData(planAssignmentRequest); Long currentMaxId = managementCollection.getMaxId(); boolean isEdit = (currentMaxId != null); List<MaximumManagementCollection> duplicateAppliesTo = maximumList.stream() .filter(e -> e.getStatus().equals(Constants.active) && e.getAppliesTo().equalsIgnoreCase(managementCollection.getAppliesTo()) && (!isEdit || !e.getMaxId().equals(currentMaxId))) .collect(Collectors.toList()); logger.info("MaximumManagementController :: checkNewMaximumMgmtDataExist() Duplicate appliesTo count: {}", duplicateAppliesTo.size()); Map<String, Integer> response = new HashMap<>(); response.put("existCount", duplicateAppliesTo.size()); response.put("identicalCount", duplicateAppliesTo.size()); return ResponseEntity.status(HttpStatus.CREATED).body(response); } @PostMapping("/isBenCatExistForClone") @ResponseBody public ResponseEntity<Object> cloneMaxiMgmtBenCatNameExist(@RequestBody CloneMaximumManagementRequestList cloneMaximumManagementRequestList, HttpServletRequest request) { HttpSession session = request.getSession(); MaximumMgmtDDMapResponse maximumMgmtDDMapResponse; if (session.getAttribute("maximumMngDDMap") == null) { maximumMgmtDDMapResponse = maximumManagementService.getMaximumMgmtDropDownsMap(); session.setAttribute("maximumMngDDMap", maximumMgmtDDMapResponse); } else { maximumMgmtDDMapResponse = (MaximumMgmtDDMapResponse) session.getAttribute("maximumMngDDMap"); } maximumManagementService.getMaxiMgmtData(cloneMaximumManagementRequestList); return ResponseEntity.status(HttpStatus.CREATED).body(Collections.singletonMap("saveSuccess", "Maximum Management Changes Cloned Successfully")); } @PostMapping("/getIfpDropdowns") @ResponseBody public List<String> getAllIFPDropdowns(HttpServletRequest request, @RequestBody Integer cocSeries) { Integer isCurrent = 1; MaximumMgmtDDMapResponse maximumMgmtDDMapResponse = maximumManagementService.getMaximumMgmtDropDownsMap(); PlIFPDropdowns plIFPDropdowns = plIFPDropdownsRepository.findByCocSeriesAndIsCurrent(cocSeries, isCurrent); List<String> productFamily = maximumMgmtDDMapResponse.getStandardMap().values().stream() .sorted() .collect(Collectors.toList()); if (plIFPDropdowns != null) { if (plIFPDropdowns.getProductFamily() != null) { productFamily = plIFPDropdowns.getProductFamily() .stream().filter(e -> e.getIsCurrent() == 1) .map(DropdownOption::getName) .sorted() .collect(Collectors.toList()); } } return productFamily; } @PostMapping("/maximumBulkCascade") @ResponseBody public ResponseEntity<Object> maximumBulkCascade(@RequestBody MaximumManagementCollection maxManagement, HttpServletRequest request) { HttpSession session = request.getSession(); String currentUser = (String) session.getAttribute(SessionConstants.USER_NAME); Long batchID = maximumManagementService.maximumBulkCascade(maxManagement, currentUser); if (batchID != null) { return ResponseEntity.status(HttpStatus.CREATED).body(Collections.singletonMap("batchID", batchID)); } else { return ResponseEntity.status(HttpStatus.CREATED).body(Collections.singletonMap("batchID", null)); } } @GetMapping("/maxManagement/product-family") @ResponseBody public List<String> findAllProductFamilies(@RequestParam String cocSeries) { return maximumManagementService.findAllProductFamilies(cocSeries); } @GetMapping("/maxManagement/applies-to") @ResponseBody public List<String> getAppliesTo(@RequestParam String cocSeries) { return maximumManagementService.findAllAppliesTo(cocSeries); } @GetMapping("/maxMgmtChangeSearch") public ModelAndView getMaxMgmtChangeSearchPage(HttpServletRequest request, ModelAndView model) { model.addObject("title", "Maximum Change Search"); model.setViewName("maxMgmtChangeSearch"); try { MaximumMgmtDDMapResponse maximumMgmtDDMapResponse; MaximumMgmtDDMapResponse maximumMgmtDDMapResponseForIEX; HttpSession session = request.getSession(); if (session.getAttribute("maximumMngDDMap") == null) { maximumMgmtDDMapResponse = maximumManagementService.getMaximumMgmtDropDownsMap(); maximumMgmtDDMapResponseForIEX = maximumManagementService.getMaximumMgmtDropDownsForIEXOrg();//product family for IEX maximumMgmtDDMapResponse.getStandardMap().clear(); maximumMgmtDDMapResponse.getStandardMap().putAll(maximumMgmtDDMapResponseForIEX.getStandardMap()); session.setAttribute("maximumMngDDMap", maximumMgmtDDMapResponse); } else { maximumMgmtDDMapResponse = (MaximumMgmtDDMapResponse) session.getAttribute("maximumMngDDMap"); } model.addObject("maximumDD", maximumMgmtDDMapResponse); List<String> benefitCategoryNames = productManagmentService.getMasterBenefitCategoryCollection() .stream() .map(MasterBenefitCategoryCollection::getBenefitCategoryValue) .sorted() .collect(Collectors.toList()); model.addObject("benefitCategoryNames", benefitCategoryNames); List<String> appliesTo = Constants.appliesTo.stream() .filter(s -> !s.trim().isEmpty()) .sorted() .collect(Collectors.toList()); model.addObject("appliesTo", appliesTo); return model; } catch (Exception exception) { return ErrorUtil.validateErrorMessage(exception); } } @PostMapping("/maxMgmtChangeSearch") @ResponseBody public List<List<String>> searchForChangedMaximum(@RequestBody MaximumChangedSearchRequest changedMaxSearchRequest) { List<List<String>> responseData = new ArrayList<>(); if ((changedMaxSearchRequest.getCocSeries() != null && !changedMaxSearchRequest.getCocSeries().isEmpty()) || (changedMaxSearchRequest.getState() != null && !changedMaxSearchRequest.getState().isEmpty()) || (changedMaxSearchRequest.getStandard() != null && !changedMaxSearchRequest.getStandard().isEmpty()) || (changedMaxSearchRequest.getBenCatName() != null && !changedMaxSearchRequest.getBenCatName().isEmpty()) || (changedMaxSearchRequest.getAppliesTo() != null && !changedMaxSearchRequest.getAppliesTo().isEmpty()) || (changedMaxSearchRequest.getModifiedBy() != null && !changedMaxSearchRequest.getModifiedBy().isEmpty()) || (changedMaxSearchRequest.getStartDate() != null && !changedMaxSearchRequest.getStartDate().toString().isEmpty()) || (changedMaxSearchRequest.getEndDate() != null && !changedMaxSearchRequest.getEndDate().toString().isEmpty()) ) { List<MaximumChangedSearchResponse> changedMaxList = maximumManagementService.getChangedMax(changedMaxSearchRequest); maximumManagementService.populateChangeTrackingResponse(responseData, changedMaxList); } return responseData; } @PostMapping("/exportMaximumManagement") public void exportToExcel(@RequestBody List<MaximumManagementCollection> payload, HttpServletResponse response) throws IOException { response.setContentType("application/octet-stream"); response.setHeader("Content-Disposition", "attachment; filename=maximumManagement.xlsx"); ByteArrayInputStream stream = maximumManagementService.maximumManagementToExcelFile(payload); if (stream != null && stream.available() > 0) { IOUtils.copy(stream, response.getOutputStream()); } else { response.sendError(HttpServletResponse.SC_NO_CONTENT, "No data to export"); } response.flushBuffer(); } @PostMapping(value = "/maxMgmtChangeTracking.xlsx") public void exportChangeTracking( @RequestBody List<List<String>> responseData, HttpServletResponse response) throws IOException { response.setContentType("application/octet-stream"); response.setHeader("Content-Disposition", "attachment; filename=changeTracking.xlsx"); ByteArrayInputStream stream = maximumManagementService.changeTrackingToExcelFile(responseData); if (stream != null && stream.available() > 0) { IOUtils.copy(stream, response.getOutputStream()); } else { response.sendError(HttpServletResponse.SC_NO_CONTENT, "No data to export"); } response.flushBuffer(); } @PostMapping("/findByFilters") public ResponseEntity<List<MaximumManagementCollection>> search(@RequestBody PlanAssignmentRequest request) { List<MaximumManagementCollection> maximumList = maximumManagementService.getMaxSearchData(request); List<MaximumManagementCollection> activeList = maximumList.stream() .filter(e -> Objects.equals(e.getStatus(), Constants.active)) .collect(Collectors.toList()); List<MaximumManagementCollection> currentDeletedList = maximumList.stream() .filter(e -> Objects.equals(e.getStatus(), Constants.currentDeleted)) .collect(Collectors.toList()); boolean enabledCascade = activeList.stream().anyMatch(MaximumManagementCollection::isBulkCascadeRequired); if (!currentDeletedList.isEmpty()) { currentDeletedList.forEach(item -> updateStatus(item.getMaxId().intValue(), Constants.deleted)); enabledCascade = true; } return ResponseEntity.ok(activeList); } @PostMapping("/findRelatedMaxIds") public ResponseEntity<List<MaximumManagementCollection>> findRelatedMaxIds(@RequestBody MaximumManagementCollection request) { List<MaximumManagementCollection> maximumManagementCollections = maximumRepo.findByBenCatNameAndStateAndCocSeriesAndStandardAndStatus( request.getBenCatName(), request.getState(), request.getCocSeries(), request.getStandard(), com.optum.ideate.utils.Constants.active); return ResponseEntity.ok(maximumManagementCollections); } @PostMapping("/bulkUpdateMaximum") public ResponseEntity<Map<String, String>> bulkUpdate(HttpServletRequest servletRequest,@RequestBody BulkUpdateRequest request) { HttpSession session = servletRequest.getSession(); String currentUser = (String) session.getAttribute(SessionConstants.USER_NAME); MaximumTrackPlanUpdates.setCurrentUser(currentUser); maximumManagementService.applyBulkUpdate(request); return ResponseEntity.status(HttpStatus.OK) .body(Collections.singletonMap("message", "Bulk update performed Successfully")); } @PostMapping("/updateOptStatus") public ResponseEntity<Map<String, String>> updateOptStatus(HttpServletRequest servletRequest, @RequestBody MaximumManagementOptPreferenceRequest request) { HttpSession session = servletRequest.getSession(); String currentUserID = (String) session.getAttribute(SessionConstants.USER_NAME); String currentUserEmail = (String) session.getAttribute(SessionConstants.USER_EMAIL); boolean optOption = (boolean) request.isOptIn(); boolean updatedOptStatus = maximumManagementService.isOptIn(currentUserID, currentUserEmail); if (updatedOptStatus != optOption) { maximumManagementService.updateOptStatus(currentUserID, currentUserEmail, optOption); } return ResponseEntity.status(HttpStatus.OK) .body(Collections.singletonMap("message", updatedOptStatus != optOption ? "Preference saved successfully" : "Opt status is already up to date")); } } package com.optum.ideate.service; import com.mongodb.client.result.UpdateResult; import com.optum.ideate.api.request.v1.DropdownOption; import com.optum.ideate.cbb.domain.COCSeries1; import com.optum.ideate.cbb.repo.CocSeries1Repository; import com.optum.ideate.model.request.*; import com.optum.ideate.model.response.MaximumChangedSearchResponse; import com.optum.ideate.model.response.MaximumManagementNoteResponse; import com.optum.ideate.model.response.MaximumMgmtDDMapResponse; import com.optum.ideate.model.response.PlanAssignmentRequest; import com.optum.ideate.mongodb.domain.MaximumManagementNotesCollection; import com.optum.ideate.mongodb.repo.MaximumManagementNotesRepository; import com.optum.ideate.mongodb.domain.*; import com.optum.ideate.mongodb.repo.*; import com.optum.ideate.planbuilder.domain.Standard; import com.optum.ideate.planbuilder.domain.State; import com.optum.ideate.planbuilder.repo.StandardRepository; import com.optum.ideate.planbuilder.repo.StateRepository; import com.optum.ideate.util.MaximumTrackPlanUpdates; import com.optum.ideate.util.PMConstants; import com.optum.ideate.utils.Constants; import org.apache.commons.collections4.CollectionUtils; import org.apache.commons.lang3.ObjectUtils; import org.apache.commons.lang3.StringUtils; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.data.mongodb.core.query.Criteria; import org.springframework.data.mongodb.core.query.Query; import org.springframework.beans.factory.annotation.Qualifier; import org.springframework.data.mongodb.core.MongoTemplate; import org.springframework.data.mongodb.core.query.Update; import org.springframework.http.HttpStatus; import org.springframework.http.ResponseEntity; import org.springframework.stereotype.Service; import java.io.IOException; import java.text.SimpleDateFormat; import java.time.LocalDateTime; import java.time.ZoneId; import java.time.ZonedDateTime; import java.time.format.DateTimeFormatter; import java.util.*; import java.util.concurrent.ConcurrentHashMap; import java.util.function.Function; import java.util.function.Predicate; import java.util.stream.Collectors; import static com.optum.ideate.aspose.Constants.currentDeleted; import static com.optum.ideate.aspose.Constants.inProgress; import static java.util.stream.Collectors.toMap; import java.io.ByteArrayInputStream; import org.apache.poi.ss.usermodel.*; import org.apache.poi.xssf.usermodel.XSSFWorkbook; import java.io.ByteArrayOutputStream; import java.util.List; @Service public class MaximumManagementServiceImpl implements MaximumManagementService { @Autowired @Qualifier("mongoTemplate") private MongoTemplate mongoTemplate; @Autowired public CocSeries1Repository cocSeriesRepository; @Autowired MaximumManagementCollectionRepository maximumRepo; @Autowired MaxMgmtProcessLogRepository maxMgmtProcessLogRepository; @Autowired public StandardRepository standardRepository; @Autowired public StateRepository stateRepository; @Autowired public MaximumManagementCollectionRepository maxRepository; @Autowired private PortfolioEditorDropDownRepository portfolioEditorDropDownRepository; @Autowired public CocSeries1Repository cocSeries1Repository; @Autowired public PortfolioBulkEditRepository portfolioBulkEditRepository; @Autowired private PlPortfolioMgmtRepository plPortfolioMgmtRepository; @Autowired private PlIFPDropdownsRepository plIFPDropdownsRepository; @Autowired private MaxMgmtChangeRepository maxMgmtChangeRepository; private MaximumManagementNotesRepository notesRepository; @Autowired public MaximumManagementServiceImpl(MaximumManagementNotesRepository notesRepository) { this.notesRepository = notesRepository; } @Autowired private MaximumManagementNotificationRepository maximumManagementNotificationRepository; private final static Logger logger = LoggerFactory.getLogger(MaximumManagementService.class); @Override public List<Map<String, Object>> getNotes(String benCatName, Long cocSeries, String state, String standard) { List<MaximumManagementNotesCollection> notes = notesRepository.findByBenCatNameAndCocSeriesAndStateAndStandardAndIsCurrent( benCatName, cocSeries, state, standard, 1 ); if (notes == null || notes.isEmpty()) { return new ArrayList<>(); } return notes.stream().map(note -> { Map<String, Object> map = new HashMap<>(); map.put("noteId", note.getNoteId()); map.put("noteDescription", note.getNoteDescription()); map.put("createdBy", note.getCreatedBy()); map.put("createdOn", note.getCreatedOn()); map.put("modifiedBy", note.getModifiedBy()); map.put("modifiedOn", note.getModifiedOn()); return map; }).toList(); } @Override public ResponseEntity<MaximumManagementNoteResponse> saveNote( MaximumManagementNoteRequest noteRequest, String currentUser) { if (currentUser == null) { return ResponseEntity.status(HttpStatus.UNAUTHORIZED) .body(new MaximumManagementNoteResponse(false, "User session expired")); } if (noteRequest.getBenCatName() == null || noteRequest.getCocSeries() == null || noteRequest.getState() == null || noteRequest.getStandard() == null || noteRequest.getNoteDescription() == null) { return ResponseEntity.status(HttpStatus.BAD_REQUEST) .body(new MaximumManagementNoteResponse(false, "Missing required fields")); } try { MaximumManagementNotesCollection note = new MaximumManagementNotesCollection(); note.setBenCatName(noteRequest.getBenCatName()); note.setCocSeries(noteRequest.getCocSeries()); note.setState(noteRequest.getState()); note.setStandard(noteRequest.getStandard()); note.setNoteDescription(noteRequest.getNoteDescription()); note.setIsCurrent(1); note.setCreatedBy(currentUser); note.setModifiedBy(currentUser); note.setCreatedOn(LocalDateTime.now()); note.setModifiedOn(LocalDateTime.now()); MaximumManagementNotesCollection lastNote = notesRepository.findTopByOrderByNoteIdDesc(); Long nextNoteId = (lastNote != null && lastNote.getNoteId() != null) ? lastNote.getNoteId() + 1 : 1L; note.setNoteId(nextNoteId); MaximumManagementNotesCollection savedNote = notesRepository.save(note); return ResponseEntity.ok( new MaximumManagementNoteResponse(true, "Note saved successfully", savedNote.getNoteId()) ); } catch (Exception e) { logger.error("Error saving note: ", e); return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body(new MaximumManagementNoteResponse(false, "Failed to save note")); } } @Override public MaximumMgmtDDMapResponse getMaximumMgmtDropDownsMap() { Integer isCurrent = 1; MaximumMgmtDDMapResponse maximumMgmtDDMapResponse = new MaximumMgmtDDMapResponse(); try { Map<String, String> cocSeriesMap = cocSeries1Repository.findAllByIsCurrentOrderByCocSeriesDesc(true).stream() .collect(toMap(COCSeries1::getCocSeries, COCSeries1::getCocSeries)); Map<String, String> standardMap = standardRepository.findAllByIsCurrent(isCurrent).stream() .collect(toMap(Standard::getDescription, Standard::getDescription)); Map<String, String> stateMap = stateRepository.findAllByIsCurrent(isCurrent).stream() .collect(toMap(State::getStateAbbr, State::getStateAbbr)); maximumMgmtDDMapResponse.getCocSeriesMap().putAll(cocSeriesMap); maximumMgmtDDMapResponse.getStandardMap().putAll(standardMap); maximumMgmtDDMapResponse.getStateMap().putAll(stateMap); } catch (Exception e) { logger.error(String.valueOf(e.getStackTrace())); } return maximumMgmtDDMapResponse; } @Override public ResponseEntity<String> deleteParentMaximum(ParentMaximumRequest requestBody, String currentUser) { MaximumTrackPlanUpdates.setCurrentUser(currentUser); List<Integer> maxIdsList = findMatchingIds(requestBody); try { for (Integer maxId : maxIdsList) { try { MaximumManagementCollection existingCollection = maximumRepo.findByMaxId(Long.valueOf(maxId)); if (existingCollection != null) { List<MaxMgmtProcessLog> deletionLogs = MaximumTrackPlanUpdates.populateDeletionLog(existingCollection, true); if (deletionLogs != null && !deletionLogs.isEmpty()) { deletionLogs.forEach(log -> maxMgmtProcessLogRepository.save(log)); logger.info("Created " + deletionLogs.size() + " deletion log records for maxId: " + maxId); } } } catch (Exception e) { logger.error("Error logging deletion for maxId: " + maxId, e); } updateStatus(maxId,currentDeleted); updateIsBulkCascadeRequired(maxId, true); MaximumManagementCollection managementCollection = maximumRepo.findByMaxId(Long.valueOf(maxId)); } return ResponseEntity.ok("Parent maximums deleted successfully."); } catch (Exception e) { return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body("An error occurred while deleting the parent maximums."); } } @Override public ResponseEntity<String> deleteParentMaximumByIds(List<Integer> maxIds, String currentUser) { MaximumTrackPlanUpdates.setCurrentUser(currentUser); try { for (Integer maxId : maxIds) { try { MaximumManagementCollection existingCollection = maximumRepo.findByMaxId(Long.valueOf(maxId)); if (existingCollection != null) { List<MaxMgmtProcessLog> deletionLogs = MaximumTrackPlanUpdates.populateDeletionLog(existingCollection, true); if (!deletionLogs.isEmpty()) { deletionLogs.forEach(log -> maxMgmtProcessLogRepository.save(log)); } } } catch (Exception e) { logger.error("Error logging deletion for maxId: " + maxId, e); } updateStatus(maxId, currentDeleted); updateIsBulkCascadeRequired(maxId, true); MaximumManagementCollection managementCollection = maximumRepo.findByMaxId(Long.valueOf(maxId)); } return ResponseEntity.ok("Parent maximums deleted successfully."); } catch (Exception e) { return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR) .body("An error occurred while deleting the parent maximums."); } } public Long updateIsBulkCascadeRequired(Integer maxId, boolean isBulkCascadeRequired) { Query query = new Query(); query.addCriteria(Criteria.where("maxId").is(maxId)); Update update = new Update(); update.set("isBulkCascadeRequired", isBulkCascadeRequired); UpdateResult result; try { result = mongoTemplate.updateFirst(query, update, MaximumManagementCollection.class); } catch (Exception e) { throw new RuntimeException("Couldn't update the data for maxId: " + maxId, e); } return result.getModifiedCount(); } public Long updateStatus(Integer maxId, String statusMessage) { Query query = new Query(); query.addCriteria(Criteria.where("maxId").is(maxId)); Update update = new Update(); update.set("status", statusMessage); UpdateResult result; try { result = mongoTemplate.updateFirst(query, update, MaximumManagementCollection.class); } catch (Exception e) { throw new RuntimeException("Couldn't update the data for maxId: " + maxId, e); } return result.getModifiedCount(); } public List<Integer> findMatchingIds(ParentMaximumRequest request) { Query query = new Query(); query.addCriteria(Criteria.where("benCatName").is(request.getBenCatName()) .and("cocSeries").is(request.getCocSeries()) .and("standard").is(request.getStandard()) .and("state").is(request.getState()) .and("status").nin(currentDeleted, com.optum.ideate.aspose.Constants.deleted)); query.fields().include("maxId"); List<MaximumManagementCollection> results = mongoTemplate.find(query, MaximumManagementCollection.class); return results.stream().map(MaximumManagementCollection::getMaxId).map(Long::intValue).collect(Collectors.toList()); } @Override public List<MaximumManagementCollection> getMaxSearchData(PlanAssignmentRequest planAssignmentRequest) { List<MaximumManagementCollection> maxList = new ArrayList<>(); try { Criteria criteria = new Criteria(); if (StringUtils.isNotEmpty(planAssignmentRequest.getCoc())) { List<Long> cocList = Arrays.stream(planAssignmentRequest.getCoc().split(",")) .map(String::trim) .map(Long::parseLong) .toList(); criteria.and("cocSeries").in(cocList); } if (StringUtils.isNotEmpty(planAssignmentRequest.getStateName())) { List<String> stateList = Arrays.stream(planAssignmentRequest.getStateName().split(",")) .map(String::trim) .toList(); criteria.and("state").in(stateList); } if (StringUtils.isNotEmpty(planAssignmentRequest.getStandard())) { List<String> standardList = Arrays.stream(planAssignmentRequest.getStandard().split(",")) .map(String::trim) .toList(); criteria.and("standard").in(standardList); } if(StringUtils.isNotEmpty(planAssignmentRequest.getBenCatName())){ List<String> bencatList = Arrays.stream(planAssignmentRequest.getBenCatName().split(",")) .map(String::trim) .toList(); criteria.and("benCatName").in(bencatList); } Query query = new Query(criteria); maxList = mongoTemplate.find(query, MaximumManagementCollection.class); maxList.sort(Comparator.comparing(MaximumManagementCollection::getBenCatName)); } catch (Exception e) { logger.error(String.valueOf(e.getStackTrace())); } return maxList; } @Override public List<MaximumManagementCollection> getAllMaxManagementData() { List<MaximumManagementCollection> maxList = new ArrayList<>(); try { maxList = maxRepository.findAll(); maxList = maxList.stream() .filter(e -> Constants.active.equals(e.getStatus())) .sorted(Comparator .comparing((MaximumManagementCollection m) -> safeString(m.getBenCatName())) .thenComparing(m -> safeString(String.valueOf(m.getCocSeries()))) .thenComparing(m -> safeString(m.getState())) .thenComparing(m -> safeString(m.getStandard())) ) .collect(Collectors.toList()); } catch (Exception e) { logger.error("Error fetching all MaximumManagement data: " + e.getMessage()); } return maxList; } private String safeString(String s) { return s == null ? "" : s.trim().toLowerCase(); } @Override public MaximumManagementCollection deleteByMaxId(Long maxId) { MaximumManagementCollection max = maxRepository.findByMaxId(maxId); if (max != null) { try { max.setStatus(Constants.deleted); maxRepository.save(max); } catch (Exception e) { e.getStackTrace(); } } return max; } @Override public MaximumManagementCollection findByMaxId(Long maxId) { MaximumManagementCollection max = maxRepository.findByMaxId(maxId); return max; } @Override public MaximumMgmtDDMapResponse getMaximumMgmtDropDownsForIEXOrg() { List<String> dropDownsForIEXOrg = null; try { PortfolioEditorDropDownCollection portfolioEditorDropDownCollection = portfolioEditorDropDownRepository.findByPageName("Portfolio Editor"); Map<String, String> standardMap = portfolioEditorDropDownCollection.getProductFamily().stream() .collect(toMap(DropdownOption::getName, DropdownOption::getName)); dropDownsForIEXOrg = standardMap.values().stream().collect(Collectors.toCollection(ArrayList::new)); } catch (Exception e) { logger.error(e.getMessage()); } MaximumMgmtDDMapResponse maximumMgmtDDMapResponse = new MaximumMgmtDDMapResponse(); try { Map<String, String> standardMap = dropDownsForIEXOrg.stream() .collect(toMap(Function.identity(), Function.identity())); maximumMgmtDDMapResponse.getStandardMap().putAll(standardMap); } catch (Exception e) { } return maximumMgmtDDMapResponse; } @Override public void getMaxiMgmtData(CloneMaximumManagementRequestList cloneMaximumManagementRequestList) { if (CollectionUtils.isNotEmpty(cloneMaximumManagementRequestList.getCloneMaximumManagementRequestList())) { PlanAssignmentRequest planAssignmentRequest = new PlanAssignmentRequest(); planAssignmentRequest.setCoc("" + cloneMaximumManagementRequestList.getCloneMaximumManagementRequestList().get(0).getCloneCoc()); planAssignmentRequest.setStateName(cloneMaximumManagementRequestList.getCloneMaximumManagementRequestList().get(0).getCloneState()); planAssignmentRequest.setStandard(cloneMaximumManagementRequestList.getCloneMaximumManagementRequestList().get(0).getCloneStandard()); List<CloneMaximumManagementRequest> cloneMaximumManagementList = cloneMaximumManagementRequestList.getCloneMaximumManagementRequestList(); List<MaximumManagementCollection> maxiMgmtList = maxRepository.findByCocSeriesAndStateAndStandard(Long.parseLong(planAssignmentRequest.getCoc()), planAssignmentRequest.getStateName(), planAssignmentRequest.getStandard()); for (MaximumManagementCollection item : maxiMgmtList) { item.setStatus("Deleted"); } maxRepository.saveAll(maxiMgmtList); for (CloneMaximumManagementRequest cloneReq : cloneMaximumManagementList) { MaximumManagementCollection max = maxRepository.findTopByOrderByMaxIdDesc(); Long maxIdVal = max.getMaxId(); MaximumManagementCollection maximumManagementCollection = new MaximumManagementCollection(); maximumManagementCollection.setMaxId(maxIdVal + 1); maximumManagementCollection.setAppliesTo(cloneReq.getCloneAppliesTo()); maximumManagementCollection.setBenCatName(cloneReq.getCloneBenefitCategoryName()); maximumManagementCollection.setState(cloneReq.getCloneState()); maximumManagementCollection.setCocSeries(cloneReq.getCloneCoc()); maximumManagementCollection.setStandard(cloneReq.getCloneStandard()); maximumManagementCollection.setFreqType(cloneReq.getCloneFreqType()); maximumManagementCollection.setFreqValue(cloneReq.getCloneFreqValue()); maximumManagementCollection.setMaxValue(cloneReq.getCloneMaxValue()); maximumManagementCollection.setMaxType(cloneReq.getCloneMaxType()); maximumManagementCollection.setCrossApplies(cloneReq.getCloneCrossApplies()); maximumManagementCollection.setStatus(Constants.active); maximumManagementCollection.setBulkCascadeRequired(true); maximumManagementCollection.setSubCategory(cloneReq.getCloneSubCategory()); maximumManagementCollection.setVisible(cloneReq.getCloneVisible()); maximumManagementCollection.setMaximumStatus(cloneReq.getCloneMaximumStatus()); maxRepository.save(maximumManagementCollection); } } } @Override public Long maximumBulkCascade(MaximumManagementCollection maxManagement, String currentUser) { try { // Insert into pl_portfolio_bulk_edit table. PortfolioBulkEdit portfolioBulkEdit = new PortfolioBulkEdit(); portfolioBulkEdit.setType("Bulk Cascade"); portfolioBulkEdit.setCascadeType("Maximum Management"); portfolioBulkEdit.setBatchStatus(PMConstants.STATUS_NEW); portfolioBulkEdit.setCreatedBy(currentUser); portfolioBulkEdit.setCreatedOn(getCurrentDateFormat()); portfolioBulkEdit.setBatchID(portfolioBulkEditRepository.findFirstByOrderByBatchIDDesc().getBatchID() + 1); List<BulkEditPlans> planList = new ArrayList<>(); List<MaximumManagementCollection> maxMgmtBulkCascadeList = maxRepository.findByIsBulkCascadeRequired(true); if(CollectionUtils.isNotEmpty(maxMgmtBulkCascadeList)) { for(MaximumManagementCollection maximumCollection : maxMgmtBulkCascadeList) { //List<PlPortfolioMgmtCollection> plPortfolioMgmtCollectionList = plPortfolioMgmtRepository.findByPlanDetailsCocSeriesAndPlanDetailsStateAbbrAndPlanDetailsStandard(maxManagement.getCocSeries(), maxManagement.getState(), maxManagement.getStandard()); List<PlPortfolioMgmtCollection> plPortfolioMgmtCollectionList = plPortfolioMgmtRepository.findByPlanDetailsCocSeriesAndPlanDetailsStateAbbrAndPlanDetailsStandardAndPlanDetailsStatusNot(maximumCollection.getCocSeries(), maximumCollection.getState(), maximumCollection.getStandard(), Constants.deleted); if(CollectionUtils.isNotEmpty(plPortfolioMgmtCollectionList)) { for (int i = 0; i < plPortfolioMgmtCollectionList.size(); i++) { if (plPortfolioMgmtCollectionList.get(i).getParentPlanAssignmentID() == null && !Constants.deleted.equalsIgnoreCase(plPortfolioMgmtCollectionList.get(i).getPlanDetails().getStatus())) { BulkEditPlans bulkEditPlans = new BulkEditPlans(); bulkEditPlans.setPlanAssignmentId(plPortfolioMgmtCollectionList.get(i).getPlanAssignmentID().toString()); bulkEditPlans.setPlanCode(plPortfolioMgmtCollectionList.get(i).getPlanDetails().getPlanCode()); bulkEditPlans.setRowNumber(null); bulkEditPlans.setCocSeries(plPortfolioMgmtCollectionList.get(i).getPlanDetails().getCocSeries()); bulkEditPlans.setStateAbbr(plPortfolioMgmtCollectionList.get(i).getPlanDetails().getStateAbbr()); bulkEditPlans.setProductFamily(plPortfolioMgmtCollectionList.get(i).getPlanDetails().getStandard()); bulkEditPlans.setPlanStatus(PMConstants.STATUS_NEW); bulkEditPlans.setPlanStatusMessage("Added in batch for update"); bulkEditPlans.setFieldName(""); bulkEditPlans.setNewValue(""); bulkEditPlans.setChangeReason("Bulk Cascade"); planList.add(bulkEditPlans); } } } } } // Remove duplicate planAssignmentId from planList as single plan has multiple BenCat with limits planList = planList.stream().filter(distinctByKey(BulkEditPlans::getPlanAssignmentId)).collect(Collectors.toList()); portfolioBulkEdit.setPlans(planList); portfolioBulkEdit = portfolioBulkEditRepository.save(portfolioBulkEdit); if (portfolioBulkEdit != null) { for (MaximumManagementCollection maxMgmtCollection : maxMgmtBulkCascadeList) { maxMgmtCollection.setBulkCascadeRequired(false); maxRepository.save(maxMgmtCollection); } return portfolioBulkEdit.getBatchID(); } else { return null; } } catch (Exception e) { logger.error("Error in MaximumManagementServiceImpl :: maximumBulkCascade() : " + e.getMessage()); return null; } } @Override public List<String> findAllProductFamilies(String cocSeries) { Set<String> productFamilies = new HashSet<>(); try { if (StringUtils.isNotEmpty(cocSeries)) { if (cocSeries.contains(",")) { String[] arrOfStr = cocSeries.split(","); for (String coc : arrOfStr) { PlIFPDropdowns plIFPDropdowns = plIFPDropdownsRepository.findByCocSeriesAndIsCurrent(Integer.parseInt(coc.trim()), 1); if (ObjectUtils.isNotEmpty(plIFPDropdowns) && ObjectUtils.isNotEmpty(plIFPDropdowns.getProductFamily())) { plIFPDropdowns.getProductFamily() .stream() .filter(e -> e.getIsCurrent() == 1) .map(DropdownOption::getName) .forEach(productFamilies::add); } } } else { PlIFPDropdowns plIFPDropdowns = plIFPDropdownsRepository.findByCocSeriesAndIsCurrent(Integer.parseInt(cocSeries), 1); if (ObjectUtils.isNotEmpty(plIFPDropdowns) && ObjectUtils.isNotEmpty(plIFPDropdowns.getProductFamily())) { plIFPDropdowns.getProductFamily() .stream() .filter(e -> e.getIsCurrent() == 1) .map(DropdownOption::getName) .forEach(productFamilies::add); } } } else { PortfolioEditorDropDownCollection portfolioEditorDropDownCollection = portfolioEditorDropDownRepository.findByPageName("Portfolio Editor"); portfolioEditorDropDownCollection.getProductFamily() .stream() .map(DropdownOption::getName) .forEach(productFamilies::add); } } catch (Exception e) { logger.error("Error in findProductFamilyByCocSeries::{}", e.getMessage()); } List<String> sortedFamilies = new ArrayList<>(productFamilies); Collections.sort(sortedFamilies); return sortedFamilies; } @Override public List<String> findAllAppliesTo(String cocSeries) { List<String> appliesTo = new ArrayList<>(); PlIFPDropdowns plIFPDropdowns = null; if (StringUtils.isNotEmpty(cocSeries)) { if (cocSeries.contains(",")) { String[] arrOfStr = cocSeries.split(","); for (String coc : arrOfStr) { plIFPDropdowns = plIFPDropdownsRepository.findByCocSeriesAndIsCurrent(Integer.parseInt(coc.trim()), 1); List<String> appliesToForEachCoc = null; if (ObjectUtils.isNotEmpty(plIFPDropdowns) && ObjectUtils.isNotEmpty(plIFPDropdowns.getAppliesTo())) { appliesToForEachCoc = plIFPDropdowns.getAppliesTo() .stream() .filter(e -> e.getIsCurrent() != null && e.getIsCurrent() == 1) .map(DropdownOption::getName) .filter(name -> name != null && !name.trim().isEmpty()) .sorted() .collect(Collectors.toList()); } if (appliesToForEachCoc!=null){ appliesTo.addAll(appliesToForEachCoc); } } } else { plIFPDropdowns = plIFPDropdownsRepository.findByCocSeriesAndIsCurrent(Integer.parseInt(cocSeries.trim()), 1); if (ObjectUtils.isNotEmpty(plIFPDropdowns) && ObjectUtils.isNotEmpty(plIFPDropdowns.getAppliesTo())) { appliesTo = plIFPDropdowns.getAppliesTo() .stream() .filter(e -> e.getIsCurrent() != null && e.getIsCurrent() == 1) .map(DropdownOption::getName) .filter(name -> name != null && !name.trim().isEmpty()) .sorted() .collect(Collectors.toList()); } } if (appliesTo.isEmpty()) { appliesTo = com.optum.ideate.aspose.Constants.appliesTo.stream() .filter(name -> name != null && !name.trim().isEmpty()) .sorted() .collect(Collectors.toList()); } } else { appliesTo = com.optum.ideate.aspose.Constants.appliesTo.stream() .filter(name -> name != null && !name.trim().isEmpty()) .sorted() .collect(Collectors.toList()); } return appliesTo; } public static <T> Predicate<T> distinctByKey(com.google.common.base.Function<? super T, ?> keyExtractor) { Set<Object> seen = ConcurrentHashMap.newKeySet(); return t -> seen.add(keyExtractor.apply(t)); } private String getCurrentDateFormat() { SimpleDateFormat dateFormat = new SimpleDateFormat(PMConstants.BATCH_DATE_FORMAT); Date date = new Date(); String formatdDate = dateFormat.format(date); return formatdDate; } @Override public List<MaximumChangedSearchResponse> getChangedMax(MaximumChangedSearchRequest changedMaxSearchRequest) { List<MaximumChangedSearchResponse> maximumSearchDataList = maxMgmtChangeRepository.getMaximumSearchData(changedMaxSearchRequest); return maximumSearchDataList; } @Override public void populateChangeTrackingResponse(List<List<String>> responseData, List<MaximumChangedSearchResponse> changedMaxList) { Comparator<MaximumChangedSearchResponse> maxComparator = (p1, p2) -> p2.getModifiedOn().compareTo(p1.getModifiedOn()); changedMaxList.stream().filter(max -> max.getModifiedOn() != null).sorted(maxComparator).forEach(changedMax -> { List<String> max = new ArrayList<>(); if (!changedMax.getChangedField().equalsIgnoreCase("Status")) { max.add(changedMax.getCocSeries()); max.add(changedMax.getState()); max.add(changedMax.getStandard()); max.add(changedMax.getBenCatName()); max.add(changedMax.getChangedField()); max.add(changedMax.getOriginalValue()); max.add(changedMax.getNewValue()); max.add(changedMax.getModifiedBy()); max.add(convertUtcToSpecificTimezone(changedMax.getModifiedOn(), "America/Chicago")); responseData.add(max); } }); } public static String convertUtcToSpecificTimezone(String utcTime, String targetTimezone) { // Define the input format DateTimeFormatter inputFormatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"); // Parse the UTC time LocalDateTime localDateTime = LocalDateTime.parse(utcTime, inputFormatter); // Convert to ZonedDateTime in UTC ZonedDateTime utcZonedDateTime = localDateTime.atZone(ZoneId.of("UTC")); // Convert to the specified timezone ZonedDateTime targetZonedDateTime = utcZonedDateTime.withZoneSameInstant(ZoneId.of(targetTimezone)); // Define the output format DateTimeFormatter outputFormatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"); // Format the result return targetZonedDateTime.format(outputFormatter); } @Override public ByteArrayInputStream changeTrackingToExcelFile(List<List<String>> responseData) { try (Workbook workbook = new XSSFWorkbook()) { Sheet sheet = workbook.createSheet("Change Tracking"); // Add bold header row String[] columns = { "COC Series", "State", "Product Family", "Benefit Category", "Field", "Original Value", "New Value", "Modified By", "Modified On" }; // Create bold font CellStyle headerStyle = workbook.createCellStyle(); Font font = workbook.createFont(); font.setBold(true); headerStyle.setFont(font); Row header = sheet.createRow(0); for (int i = 0; i < columns.length; i++) { Cell cell = header.createCell(i); cell.setCellValue(columns[i]); cell.setCellStyle(headerStyle); } // Write data rows for (int i = 0; i < responseData.size(); i++) { Row row = sheet.createRow(i + 1); // Start from row 1 (row 0 is header) List<String> rowData = responseData.get(i); for (int j = 0; j < rowData.size(); j++) { row.createCell(j).setCellValue(rowData.get(j)); } } ByteArrayOutputStream out = new ByteArrayOutputStream(); workbook.write(out); return new ByteArrayInputStream(out.toByteArray()); } catch (Exception e) { logger.error("Error generating Excel file: ", e); return new ByteArrayInputStream(new byte[0]); } } @Override public ByteArrayInputStream maximumManagementToExcelFile(List<MaximumManagementCollection> payload) throws IOException { try (Workbook workbook = new XSSFWorkbook(); ByteArrayOutputStream out = new ByteArrayOutputStream()) { Sheet sheet = workbook.createSheet("Maximum Management"); // Create Header Row Row headerRow = sheet.createRow(0); String[] headers = {"COC Series", "State", "Product Family", "Benefit Category Name", "Sub Category", "Visible", "Applies To", "Cross Applies", "Max Type", "Max Value", "Frequency Type", "Frequency Value"}; for (int i = 0; i < headers.length; i++) { Cell cell = headerRow.createCell(i); cell.setCellValue(headers[i]); cell.setCellStyle(createHeaderCellStyle(workbook)); } int rowIdx = 1; for (MaximumManagementCollection item : payload) { Row row = sheet.createRow(rowIdx++); row.createCell(0).setCellValue(item.getCocSeries()); row.createCell(1).setCellValue(item.getState()); row.createCell(2).setCellValue(item.getStandard()); row.createCell(3).setCellValue(item.getBenCatName()); row.createCell(4).setCellValue(item.getSubCategory() != null && !"null".equals(item.getSubCategory()) ? item.getSubCategory() : ""); row.createCell(5).setCellValue(item.getVisible() != null && !"null".equals(item.getVisible()) ? item.getVisible() : ""); row.createCell(6).setCellValue(item.getAppliesTo() != null && !"null".equals(item.getAppliesTo()) ? item.getAppliesTo() : ""); row.createCell(7).setCellValue(item.getCrossApplies() != null && !"null".equals(item.getCrossApplies()) ? item.getCrossApplies() : ""); row.createCell(8).setCellValue(item.getMaxType() != null && !"null".equals(item.getMaxType()) ? item.getMaxType() : ""); row.createCell(9).setCellValue(item.getMaxValue() != null && !"null".equals(item.getMaxValue()) ? item.getMaxValue() : ""); row.createCell(10).setCellValue(item.getFreqType() != null && !"null".equals(item.getFreqType()) ? item.getFreqType() : ""); row.createCell(11).setCellValue(item.getFreqValue() != null && !"null".equals(String.valueOf(item.getFreqValue())) ? String.valueOf(item.getFreqValue()) : ""); } workbook.write(out); return new ByteArrayInputStream(out.toByteArray()); } } private CellStyle createHeaderCellStyle(Workbook workbook) { CellStyle style = workbook.createCellStyle(); Font font = workbook.createFont(); font.setBold(true); style.setFont(font); return style; } @Override public List<Long> copyParentAndChildren(List<CopyParentChildRequest> copyRequests, String currentUser) { MaximumTrackPlanUpdates.setCurrentUser(currentUser); List<Long> newIds = new ArrayList<>(); for (CopyParentChildRequest copyRequest : copyRequests) { Query query = new Query(); query.addCriteria(Criteria.where("benCatName").is(copyRequest.getFromBenefitCategory())) .addCriteria(Criteria.where("cocSeries").is(copyRequest.getFromCoc())) .addCriteria(Criteria.where("state").is(copyRequest.getFromState())) .addCriteria(Criteria.where("standard").is(copyRequest.getFromProductFamily())) .addCriteria(Criteria.where("status").is(Constants.active)); List<MaximumManagementCollection> originals = mongoTemplate.find(query, MaximumManagementCollection.class); if (originals == null || originals.isEmpty()) { logger.error( "Source maximum not found for fromBenCat={}, fromCoc={}, fromState={}, fromStd={}", sanitizeForLog(copyRequest.getFromBenefitCategory()), sanitizeForLog(String.valueOf(copyRequest.getFromCoc())), sanitizeForLog(copyRequest.getFromState()), sanitizeForLog(copyRequest.getFromProductFamily())); continue; } for (MaximumManagementCollection original : originals) { Query appliesToQuery = new Query(); appliesToQuery.addCriteria(Criteria.where("benCatName").is(copyRequest.getToBenefitCategory())) .addCriteria(Criteria.where("cocSeries").is(Long.valueOf(copyRequest.getToCoc()))) .addCriteria(Criteria.where("state").is(copyRequest.getToState())) .addCriteria(Criteria.where("standard").is(copyRequest.getToProductFamily())) .addCriteria(Criteria.where("appliesTo").is(original.getAppliesTo())) .addCriteria(Criteria.where("status").is(Constants.active)); boolean appliesToExists = mongoTemplate.exists(appliesToQuery, MaximumManagementCollection.class); if (appliesToExists) { continue; } MaximumManagementCollection max = maximumRepo.findTopByOrderByMaxIdDesc(); Long newMaxId = max.getMaxId() + 1; MaximumManagementCollection copy = new MaximumManagementCollection(); copy.setBenCatName(copyRequest.getToBenefitCategory()); copy.setCocSeries(Long.valueOf(copyRequest.getToCoc())); copy.setState(copyRequest.getToState()); copy.setStandard(copyRequest.getToProductFamily()); copy.setMaxType(original.getMaxType()); copy.setMaxValue(original.getMaxValue()); copy.setAppliesTo(original.getAppliesTo()); copy.setCrossApplies(original.getCrossApplies()); copy.setFreqType(original.getFreqType()); copy.setFreqValue(original.getFreqValue()); copy.setVisible(original.getVisible()); copy.setSubCategory(original.getSubCategory()); copy.setMaxId(newMaxId); copy.setStatus(Constants.active); copy.setBulkCascadeRequired(true); copy.setMaximumStatus(inProgress); logger.info("Saving copy with maxId: " + newMaxId); maximumRepo.save(copy); newIds.add(newMaxId); List<MaxMgmtProcessLog> copyLogs = MaximumTrackPlanUpdates.populateCopyLog(original, copy); if (copyLogs != null && !copyLogs.isEmpty()) { maxMgmtProcessLogRepository.saveAll(copyLogs); logger.info("Created " + copyLogs.size() + " copy log records for maxId: " + newMaxId); } } } return newIds; } private String sanitizeForLog(String value) { if (value == null) { return null; } return value.replace('\n', ' ').replace('\r', ' '); } @Override public void applyBulkUpdate(BulkUpdateRequest request) { List<MaximumManagementCollection> toSave = new ArrayList<>(); List<MaxMgmtProcessLog> logsToSave = new ArrayList<>(); request.getMaxCollection().forEach(updatedCollection -> { MaximumManagementCollection existingCollection = cloneForTracking(updatedCollection); request.getUpdates().forEach(update -> applyField(updatedCollection, update)); toSave.add(updatedCollection); try { List<MaxMgmtProcessLog> maxMgmtProcessLogs = MaximumTrackPlanUpdates.populateDifferences(existingCollection, updatedCollection); if (maxMgmtProcessLogs != null && !maxMgmtProcessLogs.isEmpty()) { logsToSave.addAll(maxMgmtProcessLogs); logger.info("Prepared " + maxMgmtProcessLogs.size() + " log records from bulk update for maxId: " + updatedCollection.getMaxId()); } } catch (Exception e) { logger.error("Error logging records from bulk update for maxId: " + updatedCollection.getMaxId(), e); } }); if (!toSave.isEmpty()) { maximumRepo.saveAll(toSave); } if (!logsToSave.isEmpty()) { maxMgmtProcessLogRepository.saveAll(logsToSave); } } private void applyField(MaximumManagementCollection maximumManagementCollection, FieldUpdate update) { switch (update.getField()) { case "Visible": maximumManagementCollection.setVisible(update.getValue()); break; case "Cross Applies": maximumManagementCollection.setCrossApplies(update.getValue()); break; case "Max Type": maximumManagementCollection.setMaxType(update.getValue()); break; case "Max Value": maximumManagementCollection.setMaxValue(update.getValue()); break; case "Freq Type": maximumManagementCollection.setFreqType(update.getValue()); break; case "Freq Value": maximumManagementCollection.setFreqValue(Integer.parseInt(update.getValue())); break; default: throw new IllegalArgumentException("Unknown field: " + update.getField()); } } private MaximumManagementCollection cloneForTracking(MaximumManagementCollection original) { // Deep copy to preserve original values for change tracking MaximumManagementCollection clone = new MaximumManagementCollection(); clone.setId(original.getId()); clone.setMaxId(original.getMaxId()); clone.setBenCatName(original.getBenCatName()); clone.setState(original.getState()); clone.setCocSeries(original.getCocSeries()); clone.setStandard(original.getStandard()); clone.setVisible(original.getVisible()); clone.setAppliesTo(original.getAppliesTo()); clone.setCrossApplies(original.getCrossApplies()); clone.setMaxType(original.getMaxType()); clone.setMaxValue(original.getMaxValue()); clone.setFreqType(original.getFreqType()); clone.setFreqValue(original.getFreqValue()); clone.setStatus(original.getStatus()); clone.setBulkCascadeRequired(original.isBulkCascadeRequired()); clone.setSubCategory(original.getSubCategory()); return clone; } @Override public boolean isOptIn(String userId, String email) { return maximumManagementNotificationRepository.findByUserId(userId) .map(MaximumManagementNotification::isOptIn) .orElseGet(() -> { MaximumManagementNotification notification = new MaximumManagementNotification(userId, email, false); maximumManagementNotificationRepository.save(notification); return false; }); } @Override public void updateOptStatus(String userId, String email, boolean optOption) { MaximumManagementNotification notification = maximumManagementNotificationRepository.findByUserId(userId) .orElseGet(() -> new MaximumManagementNotification(userId, email, optOption)); notification.setOptIn(optOption); maximumManagementNotificationRepository.save(notification); } }

backend for max management i already have get and save note api i want an update and delete note api (post) in similar code format as rest others
also attaching js and jsp below implement a update page where update is disabled if nothing changed and relevant modals and errors and success is shown on delet and update

jsp
<%@ page import="com.optum.ideate.mongodb.domain.BenefitCategory" %> <%@ page import="java.util.List" %> <%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %> <%@taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %> <%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %> <!doctype html> <html> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script> <link rel="stylesheet" href="css/UHCcustom.css"> <link rel="stylesheet" href="css/home.css"> <link rel="stylesheet" href="css/bootstrap.css"> <link rel="stylesheet" href="css/all.css"> <link rel="stylesheet" href="css/loader.css"> <script src="js/popper-1.14.3.min.js"></script> <script src="js/datatables-1.11.5.min.js"></script> <script src="js/datatables-1.11.4.bootstrap4.min.js"></script> <script src="js/lodash-4.17.10.min.js"></script> <script src="js/UHCcustom.js"></script> <script src="js/bootstrap.min.js"></script> <script src="js/bootstrap-popup.min.js"></script> <script src="js/loader.js"></script> <script src="js/jquery-3.5.1.js"></script> <link rel="stylesheet" href="css/multislect-dropdown.css"> <script type="text/javascript" src="js/bootstrap-multiselect.js"></script> <link rel="stylesheet" href="css/bootstrap-multiselect.css"> <script src="js/app/maximum-management.js"></script> <title>Plan Library</title> <link rel="icon" href="assets/PlanBuilderFavIcon.png"> <link href="js/frappe-datatable.min.css" rel="stylesheet"> <link rel="stylesheet" href="css/fontawesome.min.css"> <link rel="stylesheet" href="css/brands.min.css"> <link rel="stylesheet" href="css/solid.min.css"> <link rel="stylesheet" href="css/max-management.css"> </head> <body> <div id="main"> <%@include file="loader.jsp" %> <%@include file="header.jsp" %> <div class="page-header"> <h1 class="page-title text-primary"> <i class="fa-solid fa-filter-circle-dollar"></i> Maximum Management </h1> <div class="header-actions"> <c:if test="${pageContext.session.getAttribute('ifpRoleId') == 8 || pageContext.session.getAttribute('ifpRoleId') == 4}"> <label class="optToggleSection toggle"> <input type="checkbox" id="optToggle" ${optOption == 'true' ? 'checked' : ''}> <span class="slider"></span> <span class="label-text">${optOption == 'true' ? 'Opted In': 'Opted Out'}</span> </label> </c:if> </div> </div> <div class="shadow-lg p-3 mb-5 bg-white rounded" style="margin:2em"> <form action="./maxManagementSearch" id="bcfilters" method="post" autocomplete="off"> <input type="hidden" id="ifpRoleId" value="${pageContext.session.getAttribute('ifpRoleId')}" /> <input type="hidden" name="validateCoc" id="validateCoc" value="" /> <!--<div class="row"> <c:if test="${enabledCascade == 'true'}"> <span class="modal-title text-danger"> <b>Warning: </b> There are benefit limit changes that have not been cascaded to applicable plans. If you do not cascade these updates, the applicable plans will not receive the changes. If you leave this page the updates will be saved but not cascaded. </span> </c:if> </div>--> </br> <div class="row"> <div class="col"> <div class="form-floating"> <select id="cocSeries" name="coc" class="form-control" multiple="multiple" onchange="return validateSearch(true),onCocChange();"> <c:forEach var="coc" items="${maximumDD.cocSeriesMap}"> <c:set var="isSelected" value="false" /> <c:forEach var="selectedCoc" items="${fn:split(fn:escapeXml(maxManagementSearchRequest.coc != null ? maxManagementSearchRequest.coc : ''), ',')}"> <c:if test="${fn:trim(selectedCoc) eq coc.key}"> <c:set var="isSelected" value="true" /> </c:if> </c:forEach> <option id="${coc.key}" value="${coc.key}" <c:if test="${isSelected}">selected</c:if>>${coc.value} </option> </c:forEach> </select> </div> </div> <div class="col"> <div class="form-floating"> <select id="state" name="stateName" class="form-control" multiple="multiple" onchange="return validateSearch(true);"> <c:forEach var="state" items="${maximumDD.stateMap}"> <c:set var="isSelected" value="false" /> <c:forEach var="selectedState" items="${fn:split(fn:escapeXml(maxManagementSearchRequest.stateName != null ? maxManagementSearchRequest.stateName : ''), ',')}"> <c:if test="${fn:trim(selectedState) eq state.key}"> <c:set var="isSelected" value="true" /> </c:if> </c:forEach> <option id="${state.key}" value="${state.key}" <c:if test="${isSelected}">selected</c:if>>${state.value} </option> </c:forEach> </select> </div> </div> <div class="col"> <div class="form-floating"> <select id="standard" name="standard" class="form-control" multiple="multiple" onchange="return validateSearch(true);"> <c:forEach var="stand" items="${maximumDD.standardMap}"> <c:set var="isSelected" value="false" /> <c:forEach var="selectedStand" items="${fn:split(fn:escapeXml(maxManagementSearchRequest.standard != null ? maxManagementSearchRequest.standard : ''), ',')}"> <c:if test="${fn:trim(selectedStand) eq stand.key}"> <c:set var="isSelected" value="true" /> </c:if> </c:forEach> <option id="${stand.key}" value="${stand.key}" <c:if test="${isSelected}">selected</c:if>>${stand.value} </option> </c:forEach> </select> </div> </div> </div> <div class="d-flex gap-2 w-100 mb-3 mt-3"> <button type="button" class="btn btn-outline-warning btn-sm flex-fill" title="Change Tracking" ${ (pageContext.session.getAttribute('ifpRoleId')==8 || pageContext.session.getAttribute('ifpRoleId')==9) ? "" : "disabled" } onclick="window.open('./maxMgmtChangeSearch', '_blank');"> <i class="fas fa-exchange-alt"></i> Change Tracking </button> <button type="button" class="btn btn-outline-danger btn-sm flex-fill" title="Delete" id="bulkDelete" onclick="showBulkMaximumManagementDeleteModal()" disabled> <i class="fas fa-trash"></i> Delete <span id="bulkDeleteCount" class="ms-1 rounded border px-1 text-xs" style="display:none; background-color:#002677; color:#fff;">0</span> </button> <button type="button" class="btn btn-outline-success btn-sm flex-fill" title="Export" id="exportBtn" onclick="exportMaximumManagement();" <c:if test="${empty maxManagementSearchRequest or empty maxManagementSearchResponse or maxManagementSearchResponse.size() == 0}">disabled</c:if>> <i class="fas fa-file-export"></i> Export </button> <button type="button" class="btn btn-outline-primary btn-sm flex-fill" data-bs-toggle="modal" id="clone" ${pageContext.session.getAttribute('ifpRoleId')==8 ? "" : "disabled"} data-bs-target="#maxCloneModal"> <i class="fas fa-clone"></i> Clone Year/State/Product </button> <button type="button" class="btn btn-outline-primary btn-sm flex-fill" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : (pageContext.session.getAttribute('ifpRoleId')==8 || pageContext.session.getAttribute('ifpRoleId')==9 || pageContext.session.getAttribute('roleId')==4 ?"":"disabled")} id="newMaximum" data-bs-toggle="modal" data-bs-target="#editVisitLimitModal"> <i class="fas fa-plus" style="font-size: 20px;"></i> New Parent Maximum </button> <button type="button" class="btn btn-outline-primary btn-sm flex-fill" id="bulkUpdate" data-bs-toggle="modal" data-bs-target="#bulkUpdateModal" onclick="clearBulkUpdate()" disabled> <i class="fas fa-clone"></i> Bulk Update <span id="bulkUpdateCount" class="ms-1 rounded border px-1 text-xs" style="display:none; background-color:#002677; color:#fff;">0</span> </button> <button type="button" class="btn btn-outline-warning btn-sm flex-fill" id="clearMaxManagement" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : ((pageContext.session.getAttribute('roleId')!=7 && maxManagementSearchResponse.size()> 0) ?"":"disabled")} onclick="clearSearch();"> <i class="fas fa-eraser"></i> Clear </button> <button type="submit" class="btn btn-outline-primary btn-sm flex-fill" id="bensearch" ${ pageContext.session.getAttribute('roleId')!=7 && maxManagementSearchResponse.size()==0 ? "disabled" :""} onclick="submitSearchForm();"> <i class="fas fa-search"></i> Search </button> </div> </form> <script type="text/javascript"> showAndHide(); (function () { setMultiSelectDropDown('#cocSeries', 'COC Series'); setMultiSelectDropDown('#state', 'State'); setMultiSelectDropDown('#standard', 'Product Family'); })(); </script> <script type="text/javascript"> var maxManagementSearchResponseVar = ${allMaxData}; </script> <div> <c:if test="${not empty maxManagementSearchRequest and (empty maxManagementSearchResponse or maxManagementSearchResponse.size() == 0)}"> <div class="p-3"> <p>No maximums configured. Please add a new maximum to begin or perform another search.</p> </div> </c:if> <div class="accordion w-100" id="maxAccordion" style="display: none;"> <c:forEach var="groupEntry" items="${maxManagementSearchResponse}" varStatus="groupLoop"> <c:set var="groupKey" value="${groupEntry.key}" /> <c:set var="groupItems" value="${groupEntry.value}" /> <c:set var="firstItem" value="${groupItems[0]}" /> <c:set var="subCount" value="${groupItems.size()}" /> <div class="accordion-item w-100 bt-1 acc-item" data-acc-idx="${groupLoop.index}"> <h2 class="accordion-header" id="heading${groupLoop.index}"> <div class="d-flex align-items-center w-100"> <input type="checkbox" class="form-check-input me-2" id="selectRowChk_${groupLoop.index}" name="selectedRows" value="${firstItem.maxId}" onclick="toggleSelectRow(${groupLoop.index});"> <div class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${groupLoop.index}" aria-expanded="false" aria-controls="collapse${groupLoop.index}"> <div class="d-flex w-100 justify-content-between align-items-center selectable-accordion m-2" id="accordionRow_${groupLoop.index}"> <div class="d-flex align-items-center gap-2"> <strong>${firstItem.benCatName} (${subCount})</strong> <small class="text-muted"> - ${firstItem.cocSeries} - ${firstItem.state} - ${firstItem.standard}</small> </div> <div></div> </div> </div> <div class="ms-auto m-2"> <c:if test="${pageContext.session.getAttribute('ifpRoleId') == 8 || pageContext.session.getAttribute('ifpRoleId') == 9 || pageContext.session.getAttribute('ifpRoleId') == 4}"> <button type="button" class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1" title="Notes" onclick="openNotesList('${firstItem.benCatName}', '${firstItem.cocSeries}', '${firstItem.state}', '${firstItem.standard}'); event.stopPropagation();"> <i class="fas fa-pencil-alt"></i> <span>Notes</span> </button> </c:if> </div> </div> </h2> <div id="collapse${groupLoop.index}" class="accordion-collapse collapse" aria-labelledby="heading${groupLoop.index}"> <div class="accordion-body"> <div class="d-flex gap-2 mb-2"> <button class="btn btn-outline-danger btn-sm" title="Delete Parent" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" } onclick="deleteParentMaximum('${firstItem.benCatName}', '${firstItem.cocSeries}', '${firstItem.state}', '${firstItem.standard}')"> <i class="fas fa-trash"></i> Delete Parent <button class="btn btn-outline-primary btn-sm" title="Copy Parent & Children" onclick="openCopyParentChildModal('${firstItem.benCatName}', '${firstItem.cocSeries}', '${firstItem.state}', '${firstItem.standard}')"> <i class="fas fa-copy"></i> Copy Parent &amp; Children </button> <button class="btn btn-outline-success btn-sm" title="Add Child Maximum" id="addChildMaximum_${groupLoop.index}" data-bs-toggle="modal" data-bs-target="#editVisitLimitModal" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : (pageContext.session.getAttribute('ifpRoleId')==8 || pageContext.session.getAttribute('ifpRoleId')==9 || pageContext.session.getAttribute('roleId')==4 ?"":"disabled")} onclick="openChildMaximumModal('${firstItem.maxId}', '${firstItem.benCatName}', '${firstItem.cocSeries}', '${firstItem.state}', '${firstItem.standard}');"> <i class="far fa-plus" style="font-size: 20px;"></i> Add Child Maximum </button> </div> <input type="hidden" name="benefitCategoryName" id="benefitCategoryName_${groupLoop.index}" value="${firstItem.benCatName}"> <input type="hidden" name="row_${groupLoop.index}" id="row_${groupLoop.index}" value="0"> <input type="hidden" name="rescoc" id="rescoc_${groupLoop.index}" value="${firstItem.cocSeries}"> <input type="hidden" name="resstateName" id="resstateName_${groupLoop.index}" value="${firstItem.state}"> <input type="hidden" name="resstandard" id="resstandard_${groupLoop.index}" value="${firstItem.standard}"> <div class="table-responsive"> <table class="table table-hover table-striped mb-0" id="newmaxtbl"> <thead> <tr> <th scope="col">Sub Category</th> <th scope="col">Visible</th> <th scope="col">Applies To</th> <th scope="col">Cross Applies</th> <th scope="col">Max Type</th> <th scope="col">Max Value</th> <th scope="col">Freq. Type</th> <th scope="col">Freq. Value</th> <th scope="col">Action</th> </tr> </thead> <tbody> <c:forEach var="maximumData" items="${groupItems}" varStatus="itemLoop"> <c:set var="loop" value="${groupLoop.index}_${itemLoop.index}" /> <tr> <td> ${maximumData.subCategory} <input type="hidden" name="subCategoryName_${loop}" id="subCategoryName_${loop}" value="${maximumData.subCategory}" /> </td> <td> <c:choose> <c:when test="${maximumData.visible == 'Yes'}"> <i class="fas fa-check-circle text-success" title="Visible"></i> </c:when> <c:when test="${not empty maximumData.visible && maximumData.visible == 'No'}"> <i class="fas fa-times-circle text-danger" title="Not visible"></i> </c:when> <c:otherwise> </c:otherwise> </c:choose> <input type="hidden" id="visible_${loop}" value="${maximumData.visible}"> </td> <td> ${maximumData.appliesTo} <input type="hidden" name="appliesTo" id="appliesTo_${loop}" value="${maximumData.appliesTo}"> </td> <td> ${maximumData.crossApplies} <input type="hidden" name="crossApplies" id="crossApplies_${loop}" value="${maximumData.crossApplies}"> </td> <td> ${maximumData.maxType} <input type="hidden" name="maxType" id="maxType_${loop}" value="${maximumData.maxType}"> </td> <td> ${maximumData.maxValue} <input type="hidden" name="maxValue" id="maxValue_${loop}" value="${maximumData.maxValue}"> </td> <td> ${maximumData.freqType} <input type="hidden" name="freqType" id="freqType_${loop}" value="${maximumData.freqType}"> </td> <td> ${maximumData.freqValue} <input type="hidden" name="freqValue" id="freqValue_${loop}" value="${maximumData.freqValue}"> </td> <td> <div class="btn-group btn-group-sm" role="group"> <div class="btn-group"> <button class="btn btn-outline-primary" data-toggle="tooltip" data-placement="bottom" ${pageContext.session.getAttribute('ifpRoleId')==10 || pageContext.session.getAttribute('ifpRoleId')==8 || pageContext.session.getAttribute('ifpRoleId')==9 || pageContext.session.getAttribute('roleId')==4 ?"":"disabled"} title="Edit" data-bs-toggle="modal" data-bs-target="#editVisitLimitModal" data-value="${maximumData.benCatName}^${maximumData.appliesTo}^${maximumData.crossApplies}^${maximumData.maxType}^${maximumData.maxValue}^${maximumData.freqType}^${maximumData.freqValue}^${maximumData.maxId}^${maximumData.subCategory}^${maximumData.visible}^${maximumData.maximumStatus}" id="editMaximum" onclick="getMaxID(${maximumData.maxId})"> <i class="fas fa-edit"></i> </button> <input type="hidden" id="editMaximum_${maximumData.maxId}" data-value="${maximumData.benCatName}^${maximumData.appliesTo}^${maximumData.crossApplies}^${maximumData.maxType}^${maximumData.maxValue}^${maximumData.freqType}^${maximumData.freqValue}^${maximumData.maxId}^${maximumData.subCategory}^${maximumData.visible}"> <button class="btn btn-outline-danger" data-toggle="tooltip" data-placement="bottom" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : (pageContext.session.getAttribute('ifpRoleId')==8 || pageContext.session.getAttribute('ifpRoleId')==9 || pageContext.session.getAttribute('roleId')==4 ?"":"disabled")} title="Deactivate" data-bs-toggle="modal" id="deleteMaximum" onclick="deleteMaximum(${maximumData.maxId})"> <i class="fas fa-trash"></i> </button> </div> </div> </td> </tr> </c:forEach> </tbody> </table> </div> </div> </div> </div> </c:forEach> <div id="maxPager" class="uhc-pager" style="display: none; margin: 1rem 2em;"> <nav aria-label="Accordion pagination"> <ul class="uhc-pager-list"> <li><button type="button" class="uhc-pager-btn" id="pagerFirst">First</button></li> <li><button type="button" class="uhc-pager-btn" id="pagerPrev">Prev</button></li> <span id="pagerNumbers"></span> <li><button type="button" class="uhc-pager-btn" id="pagerNext">Next</button></li> <li><button type="button" class="uhc-pager-btn" id="pagerLast">Last</button></li> </ul> </nav> </div> </div> </div> <div class="modal fade" id="ErrorModal" tabindex="-1" aria-labelledby="ErrorModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5> <span id="Close" class="modal-title text-danger">Error</span> </h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body" style="overflow: auto; overflow-wrap: break-word; width: 30em; max-height: 20em;"> <p> <span id="ErrorMesssage"></span> </p> </div> <div class="modal-footer"> <input type="submit" name="ErrorClose" value="Cancel" id="ErrorClose" class="btn btn-outline-danger" data-bs-dismiss="modal" autocomplete="off"> </div> </div> </div> </div> <div class="modal fade" id="editVisitLimitModal"> <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="editVisitLimitModalLabel"></h5> <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="ShowLeaveModel()"></button> </div> <div class="modal-body"> <form class="row g-3"> <input type="hidden" name="maxId" id="maxId" value="" /> <input type="hidden" name="isChildMaximum" id="isChildMaximum" value="false" /> <div class="maximumStatus"> <label for="status">Status</label> <select id="status" name="status" class="form-control" ${pageContext.session.getAttribute('ifpRoleId')==10? "disabled" : ""}> <option value="">Select...</option> <c:forEach var="stat" items="${status}"> <option value="${stat}">${stat}</option> </c:forEach> </select> </div> <!-- COC, State, Product Family fields - editable for parent, readonly for child --> <div class="col-4"> <label for="parent_coc">COC Series<span style="color: red;">*</span></label> <input type="text" class="form-control" list="parentCOCs" id="parent_coc" name="parent_coc" placeholder="COC Series" onchange="resetIfInvalid(this)" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" }> <datalist id="parentCOCs"> <c:forEach var="coc" items="${maximumDD.cocSeriesMap}"> <option value="${coc.value}">${coc.value} </option> </c:forEach> </datalist> </div> <div class="col-4"> <label for="parent_state">State<span style="color: red;">*</span></label> <input type="text" class="form-control" list="parentStates" id="parent_state" name="parent_state" placeholder="State" onchange="resetIfInvalid(this)" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" }> <datalist id="parentStates"> <c:forEach var="state" items="${maximumDD.stateMap}"> <option value="${state.value}">${state.value} </option> </c:forEach> </datalist> </div> <div class="col-4"> <label for="parent_productFamily">Product Family<span style="color: red;">*</span></label> <input type="text" class="form-control" list="parentStandards" id="parent_productFamily" name="parent_productFamily" placeholder="Product Family" onchange="resetIfInvalid(this)" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" }> <datalist id="parentStandards"> <c:forEach var="stand" items="${maximumDD.standardMap}"> <option value="${stand.value}">${stand.value} </option> </c:forEach> </datalist> </div> <div class="visitlimit_benCat"> <label for="visitlimit_benCatType">Benefit Category<span style="color: red;">*</span></label> <select id="visitlimit_bencat_Type" class="form-control adddvisitlimitbutaction" data-toggle="tooltip" data-placement="top" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" } title="Required - Select a Benefit Category type."> <option selected value="">Select...</option> <c:forEach var="benCat" items="${benefitCategoryNames}"> <option id="${benCat}" name="${benCat}"> ${benCat}</option> </c:forEach> </select> </div> <div class="col-3"> <label for="visitlimit_1_limitType">Max Type</label> <select id="visitlimit_1_limitType" class="form-control adddvisitlimitbutaction" data-toggle="tooltip" data-placement="top" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" } title="Required - Select a max type."> <option selected value="">Select...</option> <c:forEach var="limitType" items="${limitTypes}"> <option id="${limitType}" name="${limitType}"> ${limitType} </option> </c:forEach> </select> </div> <div class="col-3"> <label for="visitlimit_1_limitValue">Max Value</label> <input id="visitlimit_1_limitValue" type="text" min=1 max=999999 oninput="validity.valid||(value='');" class="form-control adddvisitlimitbutaction" placeholder="" data-toggle="tooltip" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" } onchange="validateLimitValue(this)" data-placement="top" title="Required - Enter a number greater than 1."></input> </div> <div class="col-3"> <label for="visitlimit_1_limitFreq">Frequency Value</label> <input id="visitlimit_1_limitFreq" type="number" min=1 max=9999 oninput="validity.valid||(value='');" class="form-control adddvisitlimitbutaction" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" } placeholder="" data-toggle="tooltip" data-placement="top"></input> </div> <div class="col-3"> <label for="visitlimit_1_limitFreqType">Frequency Type</label> <select id="visitlimit_1_limitFreqType" class="form-control adddvisitlimitbutaction" data-toggle="tooltip" data-placement="top" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" } title="Required - Select Months, Years, or Lifetime."> <option selected value="">Select...</option> <c:forEach var="frequencyType" items="${frequencyTypes}"> <option id="${frequencyType}" name="${frequencyType}"> ${frequencyType}</option> </c:forEach> </select> </div> <div class="dropdown-divider"></div> <div class="form-group col-4"> <label for="visitlimit_limitCross_Applies"> Cross Applies</label> <select id="visitlimit_limitCrossApplies" class="form-control adddvisitlimitbutaction" data-toggle="tooltip" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" } data-placement="top"> <option selected value="">Select...</option> <c:forEach var="crossApply" items="${crossApplies}"> <option id="${crossApply}" name="${crossApply}"> ${crossApply} </option> </c:forEach> </select> </div> <div class="form-group col-4"> <label for="visitlimit_limit_Applies">Applies To<span style="color: red;">*</span></label> <select id="visitlimit_limitApplies" class="form-control " data-toggle="tooltip" data-placement="top" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" } title="Required - Select applies to this limit."> <option selected value=" ">Select...</option> <c:forEach var="applies" items="${appliesTo}"> <option id="${applies}" name="${applies}"> ${applies}</option> </c:forEach> </select> </div> <div class="form-group col-4"> <label for="visitlimit_visible">Visible<span style="color: red;">*</span></label> <select id="visitlimit_visible" class="form-control adddvisitlimitbutaction" data-toggle="tooltip" data-placement="top" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" } title="Required - Select Yes or No."> <option selected value="">Select...</option> <c:forEach var="visibleOption" items="${visible}"> <option id="${visibleOption}" name="${visibleOption}"> ${visibleOption}</option> </c:forEach> </select> </div> <div class="visitlimit_subcategory"> <label for="visitlimit_subcategory">Sub Category</label> <input type="text" id="visitlimit_subcategory" class="form-control" readonly data-toggle="tooltip" data-placement="top" ${pageContext.session.getAttribute('ifpRoleId')==10 ? "disabled" : "" } title="Auto-populated based on Applies To selection" placeholder="Auto-populated based on Applies To"> </div> <div class="dropdown-divider"></div> <div class="col-2"> <div class="d-grid gap-2"> <button type="button" class="btn btn-block btn-outline-danger" data-bs-dismiss="modal" onclick="ShowLeaveModel()"> Cancel </button> </div> </div> <div class="col-2"> <div class="d-grid gap-2"> <button type="button" class="btn btn-block btn-outline-warning" ${pageContext.session.getAttribute("ifpRoleId")==10 ? "disabled" : "" } id="editVisitLimitModalClearBut">Clear </button> </div> </div> <div class="delete-maximum col-2"> <div class="d-grid gap-2"> <button type="button" class="btn btn-block btn-outline-danger" data-toggle="modal" data-target="#deltevisitlimitConf" id="editVisitLimitModalDeleteBut" ${pageContext.session.getAttribute("ifpRoleId")==10 ? "disabled" : "" } onclick="deleteMaximumFromEdit();">Delete </button> </div> </div> <div class="col-2"> <div class="d-grid gap-2"> <button type="button" class="btn btn-block btn-outline-primary" id="editVisitLimitModalSaveBut" ${pageContext.session.getAttribute("ifpRoleId")==10 ? "disabled" : "" } onclick="validateCoc('maxSave')" disabled>Save </button> </div> </div> </form> </div> </div> </div> </div> <div class="modal fade" id="sucessBoxNewMaximumModal" tabindex="-1" role="dialog" aria-labelledby="sucessBoxNewMaximumModalLabel" aria-hidden="true" data-bs-backdrop='static'> <div class="modal-dialog modal-dialog-centered" role="document"> <div class="modal-content"> <div class="modal-header"> <h5><span id="lblWarnTitle" class="modal-title text-success"> Success </span> </h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="reloadSearch();"></button> </div> <div class="modal-body" id="successResult"> </div> </div> </div> </div> <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered" role="document"> <div class="modal-content"> <div class="modal-header"> <h5><span id="ErrorClose" class="modal-title text-danger">Error</span></h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="reloadSearch();"></button> </div> <div class="modal-body" id="errorMesssage"></div> </div> </div> </div> <div class="modal fade" id="deleteParentConfirmBoxModal" tabindex="-1" role="dialog" aria-labelledby="deleteParentConfirmBoxModal" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered" role="document"> <div class="modal-content"> <div class="modal-header"> <h5><span id="lblParentWarnTitle" class="modal-title text-danger"> Warning </span></h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <input type="hidden" name="benCatName" id="benCatNameDelete" value="" /> <input type="hidden" name="cocSeries" id="cocSeriesDelete" value="" /> <input type="hidden" name="state" id="stateDelete" value="" /> <input type="hidden" name="standard" id="standardDelete" value="" /> Please confirm that you'd like to delete this selected parent plan? </div> <div class="modal-footer"> <input type="submit" value="Cancel" id="deleteParentClose" class="btn btn-outline-danger" data-bs-dismiss="modal" autocomplete="off"> <a onclick="deleteParentMaximumConfirm()" id="deleteParentConfirmVal" class="btn btn-outline-success" data-dismiss="modal">Confirm</a> </div> </div> </div> </div> <div class="modal fade" id="deleteConfirmBoxModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmBoxModal" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered" role="document"> <div class="modal-content"> <div class="modal-header"> <h5><span id="lblWarnTitle" class="modal-title text-danger"> Warning </span> </h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <input type="hidden" name="maxIdVal" id="maxIdVal" value="" /> Please confirm that you'd like to delete this selected plan? </div> <div class="modal-footer"> <input type="submit" value="Cancel" id="deleteClose" class="btn btn-outline-danger" data-bs-dismiss="modal" autocomplete="off"> <a onclick="deleteMaximumData()" id="deleteConfirmVal" class="btn btn-outline-success" data-dismiss="modal">Confirm</a> </div> </div> </div> </div> <!-- Clone Modal --> <div class="modal fade" id="maxCloneModal" tabindex="-1" aria-labelledby="maxCloneModalLabel" aria-hidden="true"> <div class="modal-dialog modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="maxCloneModalLabel">Clone New Maximum Configuration </h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <input type="hidden" name="cloneBenefitCategoryName" id="cloneBenefitCategoryName"> <div class="row g-2 mb-2 align-items-center"> <div class="col-6"> <div class="form-floating"> <select class="form-control" id="fromCocSeries" name="fromCocSeries" onchange="enableClone(this), onModalCocChange('fromCocSeries', 'fromStandard');"> <option value="">Select From COC Series</option> <c:forEach var="coc" items="${maximumDD.cocSeriesMap}"> <option value="${coc.key}">${coc.value} </option> </c:forEach> </select> <label for="fromCocSeries">From COC Series</label> </div> </div> <div class="col-6"> <div class="form-floating"> <select class="form-control" id="toCocSeries" name="toCocSeries" onchange="enableClone(this), onModalCocChange('fromCocSeries', 'fromStandard');"> <option value="">Select To COC Series</option> <c:forEach var="coc" items="${maximumDD.cocSeriesMap}"> <option value="${coc.key}">${coc.value} </option> </c:forEach> </select> <label for="toCocSeries">To COC Series</label> </div> </div> </div> <div class="row g-2 mb-2 align-items-center"> <div class="col-6"> <div class="form-floating"> <select class="form-control" id="fromState" name="fromState" onchange="enableClone(this);"> <option value="">Select From State</option> <c:forEach var="state" items="${maximumDD.stateMap}"> <option value="${state.key}">${state.value} </option> </c:forEach> </select> <label for="fromState">From State</label> </div> </div> <div class="col-6"> <div class="form-floating"> <select class="form-control" id="toState" name="toState" onchange="enableClone(this);"> <option value="">Select To State</option> <c:forEach var="state" items="${maximumDD.stateMap}"> <option value="${state.key}">${state.value} </option> </c:forEach> </select> <label for="toState">To State</label> </div> </div> </div> <div class="row g-2 mb-2 align-items-center"> <div class="col-6"> <div class="form-floating"> <select class="form-control" id="fromStandard" name="fromStandard" onchange="enableClone(this);"> <option value="">Select From Product Family </option> <c:forEach var="stand" items="${maximumDD.standardMap}"> <option value="${stand.key}">${stand.value} </option> </c:forEach> </select> <label for="fromStandard">From Product Family</label> </div> </div> <div class="col-6"> <div class="form-floating"> <select class="form-control" id="toStandard" name="toStandard" onchange="enableClone(this);"> <option value="">Select To Product Family </option> <c:forEach var="stand" items="${maximumDD.standardMap}"> <option value="${stand.key}">${stand.value} </option> </c:forEach> </select> <label for="toStandard">To Product Family</label> </div> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-success" disabled="" id="clonebtn" onclick="startClone();">Clone</button> </div> </div> </div> </div> <!-- Modal --> <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"> <div class="modal-dialog" role="document"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="exampleModalLabel">Leave site?</h5> <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button> </div> <div class="modal-body"> Changes you made may not be saved. </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeUpdateModel()">Leave</button> <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancel</button> </div> </div> </div> </div> <div style="position: fixed; top: 1%; right: 40%; z-index: 1;" class="toast" data-autohide="false" id="success"> <div class="toast-header"> <strong class="mr-auto text-primary"> <i class="fas fa-square" style="color: #00a550"></i>Success </strong> <button type="button" style="margin-left: 13rem;" class="btn-close" data-bs-dismiss="toast"></button> </div> <div class="toast-body" style="background-color: #E8E8E8" id="successMessage"></div> </div> <div class="modal fade" id="cascadeLeaveModal" tabindex="-1" role="dialog" aria-labelledby="cascadeLeaveModalLabel" aria-hidden="true"> <div class="modal-dialog" role="document"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="cascadeLeaveLabel">Leave site?</h5> <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button> </div> <div class="modal-body"> Warning: there are benefit limit changes that have not been cascaded to applicable plans. If you do not cascade these updates, the applicable plans will not receive the changes. If you leave this page the updates will be saved but not cascaded. </div> <div class="modal-footer"> <a type="button" class="btn btn-secondary" data-bs-dismiss="modal" href="${pageContext.session.getAttribute('planlibraryUrl')}">Leave</a> <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="restricBrowserClose()">Cancel</button> </div> </div> </div> </div> <div class="modal fade" id="bulkUpdateModal"> <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"> <div class="modal-content"> <div class="modal-header mb-2 flex justify-between items-center"> <h5 class="modal-title" id="bulkUpdateModalLabel">Bulk Update</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <p class="mb-4 text-sm text-muted">For the<span id="selectedCount" class="ms-1 text-muted"></span>, apply the following values (up to 4):</p> <div class="space-y-3"> <c:forEach var="i" begin="1" end="4"> <div class="row mb-2"> <div class="col-md-6"> <label class="form-label text-xs text-muted">Field</label> <select id="bulkField_${i}" class="form-control" onchange="handleBulkFieldChange(this, 'bulkValueInput_${i}')"> <option value="">Choose Field...</option> <option value="Visible">Visible</option> <option value="Cross Applies">Cross Applies</option> <option value="Max Type">Max Type</option> <option value="Max Value">Max Value</option> <option value="Freq Type">Freq Type</option> <option value="Freq Value">Freq Value</option> </select> </div> <div class="col-md-6"> <label class="form-label text-xs text-muted">Value</label> <span id="bulkValueInput_${i}"> <input class="form-control" type="text" disabled> </span> </div> </div> </c:forEach> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-block btn-outline-danger" data-bs-dismiss="modal">Cancel</button> <button type="button" id="applyBulkUpdate" class="btn btn-block btn-outline-primary" data-bs-dismiss="modal" onclick="applyBulkUpdate()" disabled>Apply</button> </div> </div> </div> </div> <div class="modal fade" id="bulkDeleteModal" role="dialog" aria-labelledby="bulkDeleteModal" aria-idden="true"> <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document"> <div class="modal-content"> <div class="modal-header"> <h5><span id="lblWarnTitle" class="modal-title text-danger"> Warning </span></h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> Please confirm that you'd like to delete the selected parent(s)? </div> <div class="modal-footer"> <input type="submit" value="Cancel" id="deleteClose" class="btn btn-outline-danger" data-bs-dismiss="modal" autocomplete="off"> <a onclick="maximumManagementBulkDelete();" id="deleteConfirm" class="btn btn-outline-success" data-dismiss="modal">Confirm</a> </div> </div> </div> </div> </div> <%@include file="footer.html" %> </div> <script> (function () { const PAGE_SIZE = 50; const WINDOW_SIZE = 20; const accordion = document.getElementById('maxAccordion'); if (!accordion) return; const items = Array.from(accordion.querySelectorAll('.acc-item')); const pager = document.getElementById('maxPager'); const btnFirst = document.getElementById('pagerFirst'); const btnPrev = document.getElementById('pagerPrev'); const btnNext = document.getElementById('pagerNext'); const btnLast = document.getElementById('pagerLast'); const numbersMount = document.getElementById('pagerNumbers'); if (items.length === 0) { if (pager) pager.style.display = 'none'; return; } const totalItems = items.length; const totalPages = Math.ceil(totalItems / PAGE_SIZE); let currentPage = 1; function showPage(page) { currentPage = Math.max(1, Math.min(totalPages, page)); items.forEach(el => { el.style.display = 'none'; }); const startIdx = (currentPage - 1) * PAGE_SIZE; const endIdx = Math.min(startIdx + PAGE_SIZE, totalItems); for (let i = startIdx; i < endIdx; i++) { items[i].style.display = ''; } renderWindowNumbers(); updateEdgeButtons(); pager.style.display = (totalPages > 1) ? 'flex' : 'none'; } function updateEdgeButtons() { const atFirst = currentPage === 1; const atLast = currentPage === totalPages; btnFirst.disabled = atFirst; btnPrev.disabled = atFirst; btnNext.disabled = atLast; btnLast.disabled = atLast; } function renderWindowNumbers() { numbersMount.innerHTML = ''; if (totalPages <= WINDOW_SIZE) { for (let p = 1; p <= totalPages; p++) appendPageBtn(p); return; } const half = Math.floor(WINDOW_SIZE / 2); let start = currentPage - half; let end = currentPage + half; if (WINDOW_SIZE % 2 === 0) end = currentPage + half - 1; if (start < 1) { end += (1 - start); start = 1; } if (end > totalPages) { const overshoot = end - totalPages; start = Math.max(1, start - overshoot); end = totalPages; } const visibleCount = end - start + 1; if (visibleCount < WINDOW_SIZE) { const deficit = WINDOW_SIZE - visibleCount; end = Math.min(totalPages, end + deficit); start = Math.max(1, end - WINDOW_SIZE + 1); } for (let p = start; p <= end; p++) appendPageBtn(p); } function appendPageBtn(p) { const li = document.createElement('li'); const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'uhc-pager-btn' + (p === currentPage ? ' is-active' : ''); btn.textContent = String(p); btn.setAttribute('aria-label', `Go to page ${p}`); btn.disabled = (p === currentPage); btn.addEventListener('click', function () { if (!btn.disabled) showPage(p); }); li.appendChild(btn); numbersMount.appendChild(li); } btnFirst.addEventListener('click', () => showPage(1)); btnPrev.addEventListener('click', () => showPage(currentPage - 1)); btnNext.addEventListener('click', () => showPage(currentPage + 1)); btnLast.addEventListener('click', () => showPage(totalPages)); showPage(1); window.__maxAccordionPaginate = function () { const freshItems = Array.from(accordion.querySelectorAll('.acc-item')); items.length = 0; Array.prototype.push.apply(items, freshItems); currentPage = 1; showPage(1); }; })(); const BULK_OPTIONS = { visible: [ <c:forEach var="v" items="${visible}" varStatus="s"> "${v}"<c:if test="${!s.last}">,</c:if> </c:forEach> ], crossApplies: [ <c:forEach var="c" items="${crossApplies}" varStatus="s"> "${c}"<c:if test="${!s.last}">,</c:if> </c:forEach> ], maxTypes: [ <c:forEach var="m" items="${limitTypes}" varStatus="s"> "${m}"<c:if test="${!s.last}">,</c:if> </c:forEach> ], freqTypes: [ <c:forEach var="f" items="${frequencyTypes}" varStatus="s"> "${f}"<c:if test="${!s.last}">,</c:if> </c:forEach> ]}; </script> </body> <!-- Copy Parent & Child Modal--> <div class="modal fade" id="copyParentChildModal" tabindex="-1" aria-labelledby="copyParentChildModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="copyParentChildModalLabel">Copy Parent & Child</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <form id="copyParentChildForm"> <div class="row"> <!-- From Section --> <div class="col-md-6"> <label class="form-label">From</label> <input type="text" class="form-control mb-1" id="fromBenefitCategory" readonly> <input type="text" class="form-control mb-1" id="fromCoc" readonly> <input type="text" class="form-control mb-1" id="fromStateCopy" readonly> <input type="text" class="form-control mb-1" id="fromProductFamily" readonly> </div> <!-- To Section --> <div class="col-md-6"> <label class="form-label">To</label> <input type="text" class="form-control mb-1" id="toBenefitCategory" readonly> <!-- COC Series Dropdown --> <select class="form-control mb-1" id="toCoc" name="toCoc"> <option value="">Select COC Series</option> <c:forEach var="coc" items="${maximumDD.cocSeriesMap}"> <option value="${coc.value}">${coc.value}</option> </c:forEach> </select> <!-- State Dropdown --> <select class="form-control mb-1" id="toStateCopy" name="toState"> <option value="">Select State</option> <c:forEach var="state" items="${maximumDD.stateMap}"> <option value="${state.value}">${state.value}</option> </c:forEach> </select> <!-- Product Family Dropdown --> <select class="form-control mb-1" id="toProductFamily" name="toProductFamily"> <option value="">Select Product Family</option> <c:forEach var="stand" items="${maximumDD.standardMap}"> <option value="${stand.value}">${stand.value}</option> </c:forEach> </select> </div> </div> </form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-primary" id="copyParentChildSubmit">Copy</button> </div> </div> </div> </div> <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true"> <div class="modal-dialog modal-lg modal-dialog-centered"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="notesModalLabel">Add Note</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> <div class="modal-body"> <label for="notesText" class="form-label fw-semibold"> Note <span class="text-danger">*</span> </label> <textarea class="form-control" id="notesText" rows="6" placeholder="Write your notes here..." oninput="notesInputChange()"></textarea> <div class="d-flex justify-content-between align-items-center mt-2"> <div class="invalid-feedback" id="notesError" style="display:none;"> Text exceeds maximum length </div> <small class="text-muted ms-auto"> <span id="notesCount">0</span>/2000 </small> </div> <input type="hidden" id="notesBenCatName"> <input type="hidden" id="notesCocSeries"> <input type="hidden" id="notesState"> <input type="hidden" id="notesStandard"> <input type="hidden" id="notesId"> </div> <div class="modal-footer"> <button type="button" class="btn btn-outline-warning" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-primary" id="saveNotesBtn" onclick="saveNotes()">Save</button> </div> </div> </div> </div> <div class="modal fade" id="notesListModal" tabindex="-1" aria-labelledby="notesListModalLabel" aria-hidden="true"> <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title text-primary" id="notesListModalLabel"> <i class="fas fa-sticky-note me-2"></i> Notes </h5> <div class="d-flex gap-2 ms-auto align-items-center"> <button type="button" class="btn btn-outline-primary btn-sm" id="notesListAddBtn" onclick="openAddNotesModal();"> <i class="fas fa-plus me-1"></i> Add Note </button> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div> </div> <div class="modal-body"> <div class="table-responsive"> <table class="table table-hover table-striped mb-0" id="notesListTable"> <thead> <tr> <th scope="col">Notes</th> <th scope="col">Created By</th> <th scope="col">Created On</th> <th scope="col">Modified By</th> <th scope="col">Modified On</th> <th scope="col" style="width:90px;">Action</th> </tr> </thead> <tbody id="notesListTbody"></tbody> </table> </div> <div id="notesListEmpty" class="text-muted p-2" style="display:none;"> No notes found. </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-outline-warning" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div> </body> </html>

js 
function maximumDelete(maxId){ showAndHide(); $.ajax({ type: "Delete", contentType: "application/json", url: "deleteMaximum"+'/'+maxId, dataType: 'json', success: function(response) { document.getElementById("successHeader").innerHTML = 'Deactivated'; document.getElementById("successMessage").innerHTML = 'Maximum Deactivated Successfully.'; $("#success").toast("show"); }, error: function(xhr) { console.log("error",xhr); alert("Something went wrong while deleting program, please try again..!"); } }); reloadSearch(); } function showBulkMaximumManagementDeleteModal() { $("#bulkDeleteModal").modal("toggle"); } function maximumManagementBulkDelete(){ const maxIds = []; window.selectedBulkMax.forEach(item => { maxIds.push(item.maxId); }); $("#bulkDeleteModal").modal("toggle"); showAndHide(); $.ajax({ url: "bulkDeleteParentMaximum", type: "POST", contentType: "application/json", data: JSON.stringify(maxIds), success: function(response) { $("#deleteParentConfirmBoxModal").modal('hide'); document.getElementById("successResult").innerHTML = 'Maximum Successfully Deleted'; $("#sucessBoxNewMaximumModal").modal("toggle"); showAndHide(); }, error: function(xhr) { console.error('error', xhr); alert('Something went wrong while Deleting plans, please try again..!'); reloadSearch() } }); } function reloadSearch() { showAndHide(); var coc = $("#cocSeries").val(); var state = $("#state").val(); var standard = $("#standard").val(); if (coc && coc.length > 0 || state && state.length > 0 || standard && standard.length > 0) { document.forms["bcfilters"].submit(); } else { $("#cocSeries").val(""); $("#state").val(""); $("#standard").val(""); window.location.href = "./maxManagement"; } } function validateSearch(flag) { console.log("search"); var coc = $('#cocSeries').val(); var state = $('#state').val(); var stand = $('#standard').val(); let cocSeries= coc.length > 0 ? coc.toString() : ""; let states= state.length > 0 ? state.toString() : ""; let standards= stand.length > 0 ? stand.toString() : ""; let hasAnyData = cocSeries !== "" || states !== "" || standards !== ""; document.getElementById('clearMaxManagement').disabled = !hasAnyData; document.getElementById('bensearch').disabled = !hasAnyData; if(flag) { return hasAnyData; } if(!hasAnyData) { document.getElementById('bensearch').disabled = true; document.getElementById('newMaximum').disabled = true; document.getElementById("ErrorMesssage").innerHTML = 'Please select at least one filter (COC, State, or Standard) to search.'; $("#ErrorModal").modal("toggle"); return false; } return true; } function onlyNumberKey(evt){ var ASCIICode = (evt.which) ? evt.which : evt.keyCode if (ASCIICode > 31 && (ASCIICode < 48 || ASCIICode > 57)){ document.getElementById("ErrorMesssage").innerHTML = 'COC Series should be Numeric'; $("#ErrorModal").modal("toggle"); return false; } enterKeyPressed(evt); return true; } function clearSearch(){ showAndHide(); $("#cocSeries").val(""); $("#stateName").val(""); $("#standard").val(""); document.getElementById('clearMaxManagement').disabled = true; document.getElementById('bensearch').disabled = true; window.location.href="./maxManagement"; } function submitSearchForm() { document.getElementById('bcfilters').submit(); } function setMultiSelectDropDown(id, fieldName) { $(id).multiselect({ filterPlaceholder: 'Search for ' + fieldName + '...', enableFiltering: true, enableCaseInsensitiveFiltering: true, includeSelectAllOption: true, maxHeight: 400, dropUp: true, nonSelectedText: fieldName }); } var bcOldValue; var flagModel; let initialFormState = {}; let originalStatus = ""; $(document).ready(function() { validateSearch(true); showAndHide(); $("#maxCloneModal").on("shown.bs.modal", function () { clearCloneModal(); }); $('#maxAccordion').show(); var coc = $('#cocSeries').val(); var state = $('#state').val(); var stand = $('#standard').val(); let cocSeries= coc.length > 0 ? coc.toString() : ""; let stateSeries= state.length > 0 ? state.toString() : ""; let standSeries= stand.length > 0 ? stand.toString() : ""; if(cocSeries === ""||stateSeries === ""||standSeries === "") { document.getElementById('bensearch').disabled = true; document.getElementById('newMaximum').disabled = false; } $('#editVisitLimitModal').on('hidden.bs.modal', function (e) { var validateCoc = document.getElementById("validateCoc").value; if(validateCoc != 1){ $('#editVisitLimitModalSaveBut').removeAttr("disabled"); $('#editVisitLimitModalSaveBut').html("Save"); $("#visitlimit_addlimitbuttonid").attr("enabled", "true"); $("#visitlimit_addlimitbuttonid").html("Add Limit"); $("#visitlimit_bencat_Type").val(""); $("#visitlimit_subcategory").val(""); $("#visitlimit_1_limitType").val(""); $("#visitlimit_1_limitValue").val(""); $("#visitlimit_1_limitFreq").val(""); $("#visitlimit_1_limitFreqType").val(""); $("#visitlimit_limitCrossApplies").val(""); $("#visitlimit_limitApplies").val(""); $("#visitlimit_visible").val(""); $("#maxId").val(""); $("#isChildMaximum").val("false"); $("#parent_coc").prop('readonly', false).removeAttr('readonly').off('focus'); $("#parent_state").prop('readonly', false).removeAttr('readonly').off('focus'); $("#parent_productFamily").prop('readonly', false).removeAttr('readonly').off('focus'); $("#visitlimit_bencat_Type").prop('disabled', false).removeAttr('disabled'); $("#visitlimit_subcategory").prop('readonly', false).removeAttr('readonly').off('focus'); $("#parent_coc").val(""); $("#parent_state").val(""); $("#parent_productFamily").val(""); $('#editVisitLimitModalLabel').html(''); } }); $('#editVisitLimitModal').on('shown.bs.modal', function (e) { $('#editVisitLimitModalSaveBut').attr("disabled","true"); $("#visitlimit_addlimitbuttonid").attr("disabled","true"); $("#visitlimit_addlimitbuttonid").html("Add Limit"); if (e.relatedTarget.id == 'newMaximum') { $('#editVisitLimitModalLabel').html('Add Parent Maximum'); $("#status").val("In Progress"); originalStatus = ""; $("#isChildMaximum").val("false"); $("#parent_coc").val(""); $("#parent_state").val(""); $("#parent_productFamily").val(""); $("#visitlimit_bencat_Type").val(""); $("#visitlimit_subcategory").val(""); $("#visitlimit_1_limitType").val(""); $("#visitlimit_1_limitValue").val(""); $("#visitlimit_1_limitFreq").val(""); $("#visitlimit_1_limitFreqType").val(""); $("#visitlimit_visible").val(""); $("#visitlimit_limitCrossApplies").val(""); $("#visitlimit_limitApplies").val(""); $("#maxId").val(""); $("#status").prop('disabled', true); $("#parent_coc").prop('readonly', false).removeAttr('readonly').off('focus'); $("#parent_state").prop('readonly', false).removeAttr('readonly').off('focus'); $("#parent_productFamily").prop('readonly', false).removeAttr('readonly').off('focus'); $("#visitlimit_bencat_Type").prop('disabled', false).removeAttr('disabled'); $("#visitlimit_subcategory").prop('readonly', true).on('focus', function() { $(this).blur(); }); $("#parentStandards").empty(); $('#editVisitLimitModalClearBut').prop('disabled', true); loadAppliesTo(""); loadProductFamily(""); flagModel = true; $(".delete-maximum").hide(); } else if (e.relatedTarget.id && e.relatedTarget.id.startsWith('addChildMaximum')) { // New Child Maximum - All fields already populated by openChildMaximumModal() $('#editVisitLimitModalLabel').html('Add Child Maximum'); flagModel = true; $("#status").val("In Progress"); originalStatus = ""; $("#status").prop('disabled', true); $(".delete-maximum").hide(); var cocValue = $("#parent_coc").val(); if (cocValue && cocValue.trim() !== "") { loadAppliesTo(cocValue.trim()); } } else if (e.relatedTarget.id == 'editMaximum') { $(".delete-maximum").show(); $('#editVisitLimitModalLabel').html('Edit Maximum'); $("#isChildMaximum").val("false"); var accordionItem = $(e.relatedTarget).closest('.accordion-item'); var cocSeries = accordionItem.find('input[name="rescoc"]').val(); var state = accordionItem.find('input[name="resstateName"]').val(); var standard = accordionItem.find('input[name="resstandard"]').val(); $("#parent_coc").val(cocSeries); $("#parent_state").val(state); $("#parent_productFamily").val(standard); $("#status").prop('disabled', false); $("#parent_coc").prop('readonly', true).on('focus', function() { $(this).blur(); }); $("#parent_state").prop('readonly', true).on('focus', function() { $(this).blur(); }); $("#parent_productFamily").prop('readonly', true).on('focus', function() { $(this).blur(); }); $("#visitlimit_bencat_Type").prop('disabled', true); $("#visitlimit_subcategory").prop('readonly', true).on('focus', function() { $(this).blur(); }); var maximumData = $(e.relatedTarget).data('value'); const arrMaxData = maximumData.split("^"); $("#visitlimit_bencat_Type").val(arrMaxData[0]); $("#status").val(arrMaxData[10]); originalStatus = arrMaxData[10]; $("#visitlimit_limitCrossApplies").val(arrMaxData[2]); $("#visitlimit_1_limitType").val(arrMaxData[3]); $("#visitlimit_1_limitValue").val(arrMaxData[4]); $("#visitlimit_1_limitFreqType").val(arrMaxData[5]); $("#visitlimit_1_limitFreq").val(arrMaxData[6]); $("#maxId").val(arrMaxData[7]); $("#visitlimit_subcategory").val(arrMaxData[8] || ""); if (cocSeries && cocSeries.trim() !== "") { loadAppliesTo(cocSeries.trim(), arrMaxData[1]); } else { $("#visitlimit_limitApplies").val(arrMaxData[1]); } $("#visitlimit_visible").val(arrMaxData[9]); $('#editVisitLimitModalClearBut').prop('disabled', false); flagModel = false; bcOldValue = document.getElementById("visitlimit_bencat_Type").value; initialFormState = {}; $('#editVisitLimitModal .adddvisitlimitbutaction, #editVisitLimitModal input, #editVisitLimitModal select').each(function () { initialFormState[this.id] = $(this).val(); }); } }); $('#editVisitLimitModalClearBut').on('click', function (e) { const isEditMaximum = $("#maxId").val() !== ""; $('#editVisitLimitModalSaveBut').attr("disabled", "true"); var isChildMaximum = document.getElementById("isChildMaximum").value === "true"; if (!isChildMaximum && !isEditMaximum) { $("#parent_coc").val(""); $("#parent_state").val(""); $("#parent_productFamily").val(""); $("#visitlimit_bencat_Type").val(""); $("#maxId").val(""); } $("#visitlimit_subcategory").val(""); $("#visitlimit_1_limitType").val(""); $("#visitlimit_1_limitValue").val(""); $("#visitlimit_1_limitFreq").val(""); $("#visitlimit_1_limitFreqType").val(""); $("#visitlimit_limitCrossApplies").val(""); $("#visitlimit_limitApplies").val(""); $("#visitlimit_visible").val(""); $('#editVisitLimitModalClearBut').prop('disabled', true); }); $(document).on('input change', '#editVisitLimitModal .adddvisitlimitbutaction, #editVisitLimitModal input, #editVisitLimitModal select', function () { let ifpRoleId = Number(document.getElementById('ifpRoleId').value); // Make sure this hidden field exists and is set if (ifpRoleId === 10) { $('#editVisitLimitModalSaveBut').prop('disabled', true); return; } var isChildMaximum = document.getElementById("isChildMaximum").value === "true"; const isEditMaximum = $("#maxId").val() !== ""; let cocFilled = $("#parent_coc").val() && $("#parent_coc").val().trim() !== ""; let stateFilled = $("#parent_state").val() && $("#parent_state").val().trim() !== ""; let productFamilyFilled = $("#parent_productFamily").val() && $("#parent_productFamily").val().trim() !== ""; let benCatFilled = $("#visitlimit_bencat_Type").val() && $("#visitlimit_bencat_Type").val().trim() !== ""; let appliesToFilled = $("#visitlimit_limitApplies").val() && $("#visitlimit_limitApplies").val().trim() !== ""; let visibleFilled = $("#visitlimit_visible").val() && $("#visitlimit_visible").val().trim() !== ""; let mandatoryFieldsFilled = isChildMaximum ? (benCatFilled && appliesToFilled && visibleFilled) : (cocFilled && stateFilled && productFamilyFilled && benCatFilled && appliesToFilled && visibleFilled); if (!mandatoryFieldsFilled) { $('#editVisitLimitModalSaveBut').prop('disabled', true); let hasAnyValue = $("#parent_coc").val() || $("#parent_state").val() || $("#parent_productFamily").val() || $("#visitlimit_bencat_Type").val() || $("#visitlimit_subcategory").val() || $("#visitlimit_1_limitType").val() || $("#visitlimit_1_limitValue").val() || $("#visitlimit_1_limitFreq").val() || $("#visitlimit_1_limitFreqType").val() || $("#visitlimit_visible").val() || $("#visitlimit_limitCrossApplies").val() || $("#visitlimit_limitApplies").val(); $('#editVisitLimitModalClearBut').prop('disabled', !hasAnyValue); return; } let hasAnyValue = false; if (isChildMaximum || isEditMaximum) { hasAnyValue = $("#visitlimit_subcategory").val() || $("#visitlimit_1_limitType").val() || $("#visitlimit_1_limitValue").val() || $("#visitlimit_1_limitFreq").val() || $("#visitlimit_1_limitFreqType").val() || $("#visitlimit_visible").val() || $("#visitlimit_limitCrossApplies").val() || $("#visitlimit_limitApplies").val(); } else { hasAnyValue = $("#parent_coc").val() || $("#parent_state").val() || $("#parent_productFamily").val() || $("#visitlimit_bencat_Type").val() || $("#visitlimit_subcategory").val() || $("#visitlimit_1_limitType").val() || $("#visitlimit_1_limitValue").val() || $("#visitlimit_1_limitFreq").val() || $("#visitlimit_1_limitFreqType").val() || $("#visitlimit_visible").val() || $("#visitlimit_limitCrossApplies").val() || $("#visitlimit_limitApplies").val(); } $('#editVisitLimitModalClearBut').prop('disabled', !hasAnyValue); if (isChildMaximum) { $('#editVisitLimitModalSaveBut').prop('disabled', false); } else { let hasChanged = false; $('#editVisitLimitModal .adddvisitlimitbutaction, #editVisitLimitModal input, #editVisitLimitModal select').each(function () { if (initialFormState[this.id] !== $(this).val()) { hasChanged = true; return false; } }); $('#editVisitLimitModalSaveBut').prop('disabled', !hasChanged); } }); $("#visitlimit_bencat_Type").change(function () { if (($("#visitlimit_bencat_Type").val()) == "") { $('#editVisitLimitModalSaveBut').attr("disabled","true"); } else { $('#editVisitLimitModalSaveBut').removeAttr("disabled"); } }); document.getElementById("cocSeries").addEventListener("input", function () { if ($('#cocSeries').val() === null || $('#cocSeries').val().length === 0) { onCocChange(); } }); $("#parent_coc").on('input change', function() { var cocValue = $(this).val(); $("#parent_productFamily").val(""); $("#parentStandards").empty(); $("#visitlimit_subcategory").val(""); if (cocValue && cocValue.trim() !== "") { onCocChange(true); loadAppliesTo(cocValue.trim()); } else { loadAppliesTo(""); loadProductFamily(""); } }); function loadAppliesTo(cocValue, selectedValue) { $.ajax({ url: "maxManagement/applies-to", type: 'GET', data: { cocSeries: cocValue }, success: function(appliesTo) { $("#visitlimit_limitApplies").empty(); $("#visitlimit_limitApplies").append('<option selected value=" ">Select...</option>'); if (appliesTo && appliesTo.length > 0) { for (var i = 0; i < appliesTo.length; i++) { $("#visitlimit_limitApplies").append( '<option value="' + appliesTo[i] + '">' + appliesTo[i] + '</option>' ); } } if (selectedValue) { $("#visitlimit_limitApplies").val(selectedValue); } }, error: function(xhr) { console.error("Error loading appliesTo:", xhr); console.error("Status:", xhr.status, "Response:", xhr.responseText); } }); } function loadProductFamily(cocValue) { $.ajax({ url: "maxManagement/product-family", type: 'GET', data: { cocSeries: cocValue }, success: function(productFamilies) { $("#parentStandards").empty(); if (productFamilies && productFamilies.length > 0) { for (var i = 0; i < productFamilies.length; i++) { $("#parentStandards").append( '<option value="' + productFamilies[i] + '">' + productFamilies[i] + '</option>' ); } } }, error: function(xhr) { console.error("Error loading product families:", xhr); console.error("Status:", xhr.status, "Response:", xhr.responseText); } }); } $("#visitlimit_limitApplies").on('change', function() { var appliesToValue = $(this).val(); var cocValue = $("#parent_coc").val(); $("#visitlimit_subcategory").val(""); if (appliesToValue && appliesToValue.trim() !== "" && appliesToValue.trim() !== " ") { if (cocValue && cocValue.trim() !== "") { $.ajax({ url: "maxManagement/subcategory-by-appliesTo", type: 'GET', data: { cocSeries: cocValue.trim(), appliesTo: appliesToValue.trim() }, success: function(subCategory) { if (subCategory && subCategory.trim() !== "") { $("#visitlimit_subcategory").val(subCategory); } }, error: function(xhr) { console.error("Error fetching subcategory:", xhr); } }); } } }); $('#optToggle').change(function() { const optOption = $(this).is(':checked'); $.ajax({ url: "updateOptStatus", data: JSON.stringify({optIn: optOption}), contentType: "application/json", type: "POST", success: function(response) { // success modal can be added here //document.getElementById("successOptOptionResult").innerHTML = response.message; //$("#successOptOptionModal").modal("show"); }, error: function() { document.getElementById("ErrorMesssage").innerHTML = 'Failed to save preference.'; $('#ErrorModal').modal('show'); } }); $('.label-text').text(optOption ? 'Opted In' : 'Opted Out'); }); }); function saveNewMaximumWithBenCatCheck() { const currentStatus = $("#status").val(); const isEditMaximum = $("#maxId").val() !== ""; if (isEditMaximum && originalStatus && !validateStatusSequence(currentStatus)) { document.getElementById("ErrorMesssage").innerHTML = 'Invalid Transaction.'; $("#ErrorModal").modal("show"); return; } showAndHide(); if(flagModel) { console.log("New Maximum Mgmt flagModel : ",flagModel); isNewMaximumMgmtBenCatExist(); } else { console.log("Edit Maximum Mgmt flagModel : ",flagModel); isNewMaximumMgmtBenCatExist(); } } function isNewMaximumMgmtBenCatExist() { console.log("isNewMaximumMgmtBenCatExist"); checkNewMaximumMgmtBenCatExist().then(response => { if(response != null) { if(response.identicalCount == 0) { saveNewMaximum(); } else { showAndHide(); document.getElementById("ErrorMesssage").innerHTML = 'The combination that you entered already exists.'; $('#ErrorModal').modal('show'); } } else { showAndHide(); document.getElementById("ErrorMesssage").innerHTML = 'Something went wrong, please try again..!'; $('#ErrorModal').modal('show'); } }); } function checkNewMaximumMgmtBenCatExist() { console.log("checkNewMaximumMgmtBenCatExist"); var request = {}; request['cocSeries'] = $("#parent_coc").val(); request['state'] = $("#parent_state").val(); request['standard'] = $("#parent_productFamily").val(); request['benCatName'] = document.getElementById("visitlimit_bencat_Type").value; request['subCategory'] = document.getElementById("visitlimit_subcategory").value || ""; request['appliesTo'] = document.getElementById("visitlimit_limitApplies").value; request['maxType'] = document.getElementById("visitlimit_1_limitType").value; request['maxValue'] = document.getElementById("visitlimit_1_limitValue").value; request['freqValue'] = document.getElementById("visitlimit_1_limitFreq").value; request['freqType'] = document.getElementById("visitlimit_1_limitFreqType").value; request['visible'] = document.getElementById("visitlimit_visible").value; request['crossApplies'] = document.getElementById("visitlimit_limitCrossApplies").value; request['maximumStatus'] = document.getElementById("status").value; var maxId = document.getElementById("maxId").value; if (maxId != null && maxId != '') { request['maxId'] = parseInt(maxId); } if (request.benCatName != ''){ return $.ajax({ type: "POST", contentType: "application/json", url: "isBenCatExistForNewMaximumMgmt", data: JSON.stringify(request), dataType: 'json' }); } else { showAndHide(); $("#editVisitLimitModal").modal('hide'); document.getElementById("errorMesssage").innerHTML = 'Please select Benefit Category Name'; $("#errorModal").modal("toggle"); } return null; } function saveNewMaximum(){ console.log("saveNewMaximum"); var request = {}; request['cocSeries'] = $("#parent_coc").val(); request['state'] = $("#parent_state").val(); request['standard'] = $("#parent_productFamily").val(); var maxId = document.getElementById("maxId").value; if (maxId != '') { console.log("There is no maxId id: Its a new plan"); console.log("Editing existing maximum with maxId: ", maxId); request['maxId'] = maxId; } request['benCatName'] = document.getElementById("visitlimit_bencat_Type").value; request['subCategory'] = document.getElementById("visitlimit_subcategory").value || ""; request['maxType'] = document.getElementById("visitlimit_1_limitType").value; request['maxValue'] = document.getElementById("visitlimit_1_limitValue").value; let freqValueStr = document.getElementById("visitlimit_1_limitFreq").value; request['freqValue'] = freqValueStr === "" ? null : parseInt(freqValueStr); request['freqType'] = document.getElementById("visitlimit_1_limitFreqType").value; request['crossApplies'] = document.getElementById("visitlimit_limitCrossApplies").value; request['appliesTo'] = document.getElementById("visitlimit_limitApplies").value; request['visible'] = document.getElementById("visitlimit_visible").value; request['status'] = 'Active'; request['maximumStatus'] = document.getElementById("status").value; saveNewMaximumData(request); } function saveNewMaximumData(request) { console.log("saveNewMaximumData"); if (request.benCatName != ''){ $.ajax({ type: "POST", contentType: "application/json", url: "saveNewMaximum", data: JSON.stringify(request), dataType: 'json', success: function (res) { console.log(res); // Hide loader before showing modal showAndHide(); if (res.newMaximums == 0) { document.getElementById("ErrorMesssage").innerHTML = 'The combination that you entered already exists.'; $('#ErrorModal').modal('show'); } else { $("#editVisitLimitModal").modal('hide'); document.getElementById("successResult").innerHTML = 'Maximum Successfully Saved'; $("#sucessBoxNewMaximumModal").modal("show"); } }, error: function (xhr) { console.log("error",xhr); // Hide loader before showing error showAndHide(); alert("Something went wrong while saving plans, please try again..!"); $('#ErrorModal').modal('show'); } }); } } function deleteMaximum(maxIdVal){ $("#deleteConfirmBoxModal").modal("toggle"); $('#maxIdVal').val(maxIdVal); } function deleteParentMaximum(benCatName, cocSeries, state, standard) { console.log(benCatName, cocSeries, state, standard); $("#deleteParentConfirmBoxModal").modal("toggle"); $('#benCatNameDelete').val(benCatName); $('#cocSeriesDelete').val(cocSeries); $('#stateDelete').val(state); $('#standardDelete').val(standard); } function exportMaximumManagement() { console.log("Payload being sent:", JSON.stringify(maxManagementSearchResponseVar)); if (maxManagementSearchResponseVar != null) { showAndHide(); $.ajax({ type: "POST", contentType: "application/json", url: "exportMaximumManagement", data: JSON.stringify(maxManagementSearchResponseVar), cache: false, xhr: function () { var xhr = new XMLHttpRequest(); xhr.onreadystatechange = function () { if (xhr.readyState == 2) { if (xhr.status == 200) { xhr.responseType = "blob"; } else { xhr.responseType = "text"; } } }; return xhr; }, success: function (data) { var blob = new Blob([data], { type: "application/octetstream"}); if (window.navigator.msSaveBlob) { window.navigator.msSaveBlob(blob, "maximumManagement.xlsx"); } else { var windUrl = window.URL || window.webkitURL; var url = windUrl.createObjectURL(blob); var link = document.createElement("a"); link.href = url; link.setAttribute("download", "maximumManagement.xlsx"); document.body.appendChild(link); link.click(); link.remove(); } showAndHide(); }, error: function (xhr,textStatus, errorThrown) { showAndHide(); } }); } } function deleteParentMaximumConfirm() { var benCatNameVal=document.getElementById("benCatNameDelete").value; var cocSeriesVal=document.getElementById("cocSeriesDelete").value; var stateVal=document.getElementById("stateDelete").value; var standardVal=document.getElementById("standardDelete").value; console.log(benCatNameVal, cocSeriesVal, stateVal, standardVal); $.ajax({ url: "deleteParentMaximum", type: "POST", contentType: "application/json", data: JSON.stringify({ benCatName: benCatNameVal, cocSeries: cocSeriesVal, state: stateVal, standard: standardVal }), success: function(response) { $("#deleteParentConfirmBoxModal").modal('hide'); document.getElementById("successResult").innerHTML = 'Maximum Successfully Deleted'; $("#sucessBoxNewMaximumModal").modal("toggle"); }, error: function(xhr) { console.error('error', xhr); alert('Something went wrong while Deleting plans, please try again..!'); } }); } function deleteMaximumData() { var request = document.getElementById("maxIdVal").value; if (request != ''){ $.ajax({ type: "POST", contentType: "application/json", url: "deletePlanConfirm", data: JSON.stringify(request), dataType: 'json', success: function (res) { $("#deleteConfirmBoxModal").modal('hide'); console.log(res); document.getElementById("successResult").innerHTML = 'Maximum Successfully Deleted'; $("#sucessBoxNewMaximumModal").modal("toggle"); }, error: function (xhr) { console.log("error",xhr); alert("Something went wrong while Deleting plans, please try again..!"); } }); } } function deleteMaximumFromEdit() { var maxId = document.getElementById("maxId").value; $("#editVisitLimitModal").modal('hide'); deleteMaximum(maxId); } function validateClone() { const anyRow = document.querySelector('input[id^="editMaximum_"]'); if (anyRow) { const parts = (anyRow.getAttribute('data-value') || '').split('^'); const benCat = parts[0] || ''; const cocInput = document.querySelector('input[id^="rescoc_"]'); const stateInput = document.querySelector('input[id^="resstateName_"]'); const standardInput = document.querySelector('input[id^="resstandard_"]'); if (cocInput) document.getElementById("cloneCoc").value = cocInput.value || ""; if (stateInput) document.getElementById("cloneState").value = stateInput.value || ""; if (standardInput) document.getElementById("cloneStandard").value = standardInput.value || ""; document.getElementById("cloneBenefitCategoryName").value = benCat; document.getElementById("cloneAppliesTo").value = parts[1] || ''; document.getElementById("cloneCrossAppliesTo").value = parts[2] || ''; document.getElementById("cloneMaxType").value = parts[3] || ''; document.getElementById("cloneMaxValue").value = parts[4] || ''; document.getElementById("cloneFreqType").value = parts[5] || ''; document.getElementById("cloneFreqValue").value = parts[6] || ''; } document.getElementById('clonebtn').disabled = false; $("#maxCloneModal").modal("toggle"); } function enableClone(lists) { let fromCoc = document.getElementById('fromCocSeries').value; let toCoc = document.getElementById('toCocSeries').value; let fromState = document.getElementById('fromState').value; let toState = document.getElementById('toState').value; let fromStandard = document.getElementById('fromStandard').value; let toStandard = document.getElementById('toStandard').value; let allSelected = fromCoc && toCoc && fromState && toState && fromStandard && toStandard; document.getElementById('clonebtn').disabled = !allSelected; } function onCocChange(isModal) { isModal = isModal || false; showAndHide(); var cocName, cocSeries; if (isModal) { cocName = $('#parent_coc').val(); cocSeries = (cocName && cocName.trim() !== "") ? cocName.trim() : ""; } else { cocName = $('#cocSeries').val(); cocSeries = (cocName && cocName.length > 0) ? cocName.toString() : ""; } $.ajax({ url: "maxManagement/product-family?cocSeries=" + cocSeries, type: 'GET', success: function(res) { if (isModal) { $("#parentStandards").empty(); if (res && res.length > 0) { for (var i = 0; i < res.length; i++) { var option = document.createElement("option"); option.value = res[i]; option.text = res[i]; $("#parentStandards").append(option); } console.log("Product families loaded for modal COC:", cocSeries); } } else { var selectedProductFamilies = $('#standard').val(); updateProductFamilyDropDown(res, selectedProductFamilies); validateSearch(true); } showAndHide(); }, error: function(xhr) { console.error("Error loading product families:", xhr); showAndHide(); } }); } function getDropdownValues(dropdownId) { let values = []; $(`#${dropdownId} option`).each(function() { values.push($(this).val()); }); return values; } function updateProductFamilyDropDown(res,selectedProductFamilies){ var standards = document.getElementById("standard"); $("#standard option").remove(); $('#standard').multiselect('rebuild'); for (var i = 0; i < res.length; i++) { var option = document.createElement("option"); option.value = res[i]; option.innerText = res[i]; standards.appendChild(option); } $('#standard').val(selectedProductFamilies); $('#standard').multiselect('rebuild'); } function removeOptions(selectElement) { var i, L = selectElement.options.length - 1; for(i = L; i >= 0; i--) { selectElement.children[i].remove() } } function getIEXOrgProductFamily(standards){ $.ajax({ url: "portfolioManagement/iex-product-family", type: 'GET', success: function(res) { removeOptions(standards); for (var i = 0; i < res.length; i++) { var option = document.createElement("option"); option.value = res[i]; option.innertText = res[i]; standards.appendChild(option); } } }); } function getAllProductFamily(standards){ $.ajax({ url: "maxManagement/all-product-family", type: 'GET', success: function(res) { removeOptions(standards); for (var i = 0; i < res.length; i++) { var option = document.createElement("option"); option.value = res[i]; option.innertText = res[i]; standards.appendChild(option); } } }); } function enterKeyPressed(event) { if (event.keyCode == 13 && event.key === "Enter") { event.preventDefault(); document.getElementById("bensearch").click(); } } function ShowLeaveModel(){ var prevResponseArray = prevMaximumArray(); var currResponseArray = currMaximumArray(); if(_.isEqual(currResponseArray, prevResponseArray)){ $("#editVisitLimitModal").modal('hide'); }else{ $("#exampleModal").modal('show'); } } function closeUpdateModel(){ $("#exampleModal").modal('hide'); $("#editVisitLimitModal").modal('hide'); } var globalMaxID; function getMaxID(maxID){ globalMaxID = maxID; } function prevMaximumArray() { var prevResponseObj = {}; var editMaxId = document.getElementById("editMaximum_" + globalMaxID); if (editMaxId) { var prevArray = document.getElementById("editMaximum_" + globalMaxID).getAttribute('data-value'); const myArray = prevArray.split("^"); prevResponseObj['benCatName'] = myArray[0]; prevResponseObj['appliesTo'] = myArray[1]; prevResponseObj['crossApplies'] = myArray[2]; prevResponseObj['maxType'] = myArray[3]; prevResponseObj['maxValue'] = myArray[4]; prevResponseObj['freqType'] = myArray[5]; prevResponseObj['freqValue'] = myArray[6]; prevResponseObj['subCategory'] = myArray[8] || ""; prevResponseObj['visible'] = myArray[9]; prevResponseArray = JSON.stringify(prevResponseObj); return prevResponseArray; } } function currMaximumArray(){ var currResponseObj = {}; currResponseObj['benCatName'] = document.getElementById("visitlimit_bencat_Type").value; currResponseObj['subCategory'] = document.getElementById("visitlimit_subcategory").value || ""; currResponseObj['appliesTo'] = document.getElementById("visitlimit_limitApplies").value; currResponseObj['crossApplies'] = document.getElementById("visitlimit_limitCrossApplies").value; currResponseObj['maxType'] = document.getElementById("visitlimit_1_limitType").value; currResponseObj['maxValue'] = document.getElementById("visitlimit_1_limitValue").value; currResponseObj['freqType'] = document.getElementById("visitlimit_1_limitFreqType").value; currResponseObj['freqValue'] = document.getElementById("visitlimit_1_limitFreq").value; currResponseObj['visible'] = document.getElementById("visitlimit_visible").value; currResponseArray = JSON.stringify(currResponseObj); return currResponseArray; } function validateLimitValue(field) { if(validateNumeric(field)) { field.value=''; return false; } if(parseInt(field.value) < 1 || parseInt(field.value) > 999999) { field.value=''; return false; } if(parseInt(field.value) >= 1 || parseInt(field.value) <= 999999){ field.value = parseInt(field.value).toLocaleString('en-US'); } } function validateNumeric(number) { if (number.value != "") { if (number.value.includes('$')) { number.value = number.value.replace('$', ''); } if (number.value.includes(',')) { number.value = number.value.replace(',', ''); } //var numbers = /^[+]?[0-9]+$/; var numbers = /^[0-9]\d*(\.\d+)?$/; if (!number.value.match(numbers)) { number.value = ''; return true; } } } function resetIfInvalid(el){ if (el.value == "") { return; } if (!el.list || !el.list.options) { el.value = ""; return; } var options = el.list.options; for (var i = 0; i< options.length; i++) { if (el.value == options[i].value) { return; } } el.value = ""; } function getCloneIfpDropdowns(){ var standards = document.getElementById("clonestandards"); var cocSeries = $('#cloneCoc').val(); if(cocSeries !== "") { showAndHide(); $("#cloneStandard").val(""); $.ajax({ type: "POST", contentType: "application/json", url: "getIfpDropdowns", data: cocSeries, dataType: 'json', success: function(res) { removeOptions(standards); for (var i = 0; i < res.length; i++) { var option = document.createElement("option"); option.value = res[i]; option.innertText = res[i]; standards.appendChild(option); } showAndHide(); } }); } } function maximumBulkCascade(){ showAndHide(); var request = {}; request['cocSeries'] = $("#cocSeries").val(); request['state'] = $("#state").val(); request['standard'] = $("#standard").val(); $.ajax({ type: "POST", contentType: "application/json", url: "maximumBulkCascade", data: JSON.stringify(request), dataType: 'json', success: function (res) { if(res.batchID != null){ document.getElementById("successResult").innerHTML = 'Maximum Cascade Batch created with Batch ID : '+res.batchID; $("#sucessBoxNewMaximumModal").modal("toggle"); }else{ document.getElementById("errorMesssage").innerHTML = 'Batch creation Failed'; $("#errorModal").modal("toggle"); } showAndHide(); }, error: function (xhr) { console.log("error",xhr); alert("Something went wrong while saving plans, please try again..!"); } }); } function openChildMaximumModal(parentMaxId, benefitCategory, cocSeries, state, standard) { console.log("openChildMaximumModal - Parent:", parentMaxId, "BenCat:", benefitCategory, "COC:", cocSeries, "State:", state, "Standard:", standard); $("#isChildMaximum").val("true"); $("#parent_coc").val(cocSeries); $("#parent_state").val(state); $("#parent_productFamily").val(standard); $("#visitlimit_bencat_Type").val(benefitCategory); $("#parent_coc").prop('readonly', true).on('focus', function() { $(this).blur(); }); $("#parent_state").prop('readonly', true).on('focus', function() { $(this).blur(); }); $("#parent_productFamily").prop('readonly', true).on('focus', function() { $(this).blur(); }); $("#visitlimit_bencat_Type").prop('disabled', true); $("#visitlimit_subcategory").prop('readonly', true).on('focus', function() { $(this).blur(); }); $("#maxId").val(""); $("#visitlimit_subcategory").val(""); $("#visitlimit_1_limitType").val(""); $("#visitlimit_1_limitValue").val(""); $("#visitlimit_1_limitFreq").val(""); $("#visitlimit_1_limitFreqType").val(""); $("#visitlimit_visible").val(""); $("#visitlimit_limitCrossApplies").val(""); $("#visitlimit_limitApplies").val(""); } function startClone() { const from = { cocSeries: (document.getElementById("fromCocSeries")?.value || '').trim() || null, state: (document.getElementById("fromState")?.value || '').trim() || null, standard: (document.getElementById("fromStandard")?.value || '').trim() || null, }; const to = { cocSeries: (document.getElementById("toCocSeries")?.value || '').trim() || null, state: (document.getElementById("toState")?.value || '').trim() || null, standard: (document.getElementById("toStandard")?.value || '').trim() || null, }; const hasFrom = !!(from.cocSeries || from.state || from.standard); const hasTo = !!(to.cocSeries || to.state || to.standard); if (!hasFrom) { setError('Please provide at least one "From" filter (COC, State or Product Family).', "#ErrorModal", "ErrorMesssage"); return; } if (!hasTo) { setError('Please provide at least one "To" value (COC, State or Product Family).', "#ErrorModal", "ErrorMesssage"); return; } fetchFromRowsByFilters({ from, to }); } function fetchFromRowsByFilters(payload) { showAndHide(); $.ajax({ type: "POST", contentType: "application/json", url: "findByFilters", data: JSON.stringify({ coc: payload.from.cocSeries, stateName: payload.from.state, standard: payload.from.standard }), dataType: 'json', success: function (rows) { if (!rows || rows.length === 0) { showAndHide(); setError('No records found for the selected "From" filter.', "#ErrorModal", "ErrorMesssage"); return; } const cloneList = []; let rowCounter = 1; rows.forEach(function (r) { const rowCoc = r?.cocSeries ?? r?.coc ?? null; const rowState = r?.state ?? r?.stateName ?? null; const rowStandard = r?.standard ?? r?.productFamily ?? null; const p = { cloneCoc: (payload.to.cocSeries ?? rowCoc) ?? null, cloneState: (payload.to.state ?? rowState) ?? null, cloneStandard: (payload.to.standard ?? rowStandard) ?? null, cloneBenefitCategoryName: r?.benCatName || '', cloneAppliesTo: r?.appliesTo || '', cloneCrossApplies: r?.crossApplies || '', cloneMaxType: r?.maxType || '', cloneMaxValue: r?.maxValue || '', cloneFreqType: r?.freqType || '', cloneFreqValue: r?.freqValue || '', cloneSubCategory: r?.subCategory || '', cloneVisible: r?.visible ?? '', cloneMaximumStatus: 'In Progress', row: rowCounter++, }; if (p.cloneBenefitCategoryName) { cloneList.push(p); } }); if (cloneList.length === 0) { showAndHide() setError('No benefit categories available under the selected "From" filter.', "#ErrorModal", "ErrorMesssage"); return; } $.ajax({ type: "POST", contentType: "application/json", url: "isBenCatExistForClone", data: JSON.stringify({ cloneMaximumManagementRequestList: cloneList }), dataType: 'json', success: function (resClone) { showAndHide(); document.getElementById("successMessage").innerHTML = resClone?.saveSuccess || 'Clone completed successfully.'; $("#success").toast("show"); $("#maxCloneModal").modal("toggle"); }, error: function () { showAndHide(); setError('Something went wrong while cloning, please try again..!', "#ErrorModal", "ErrorMesssage"); } }); }, error: function () { showAndHide(); setError('Something went wrong while fetching data for the "From" filters.', "#ErrorModal", "ErrorMesssage"); } }); } function setError(message, modalSelector, idAttr) { $("#maxCloneModal").modal('hide'); const el = document.getElementById(idAttr) || document.getElementById("ErrorMesssage") || document.getElementById("errorMesssage"); if (el) el.innerHTML = message; if (modalSelector) $(modalSelector).modal("toggle"); } function clearCloneModal() { const idsToClear = [ "fromCocSeries", "fromState", "fromStandard", "toCocSeries", "toState", "toStandard" ]; idsToClear.forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; }); } function openCopyParentChildModal(benCat, coc, state, productFamily) { $('#fromBenefitCategory').val(benCat); $('#fromCoc').val(coc); $('#fromStateCopy').val(state); $('#fromProductFamily').val(productFamily); $('#toBenefitCategory').val(benCat); $('#toCoc').val(''); $('#toStateCopy').val(''); $('#toProductFamily').val(''); $('#copyParentChildModal').modal('show'); $('#copyParentChildSubmit').off('click').on('click', function() { var copyRequest = { fromBenefitCategory: $('#fromBenefitCategory').val(), fromCoc: $('#fromCoc').val(), fromState: $('#fromStateCopy').val(), fromProductFamily: $('#fromProductFamily').val(), toBenefitCategory: $('#toBenefitCategory').val(), toCoc: $('#toCoc').val(), toState: $('#toStateCopy').val(), toProductFamily: $('#toProductFamily').val() }; console.log("Copy Request being sent:", copyRequest); $.ajax({ url: 'copyParentAndChildren', type: 'POST', contentType: 'application/json', data: JSON.stringify([copyRequest]), success: function(response) { $('#copyParentChildModal').modal('hide'); document.getElementById("successMessage").innerHTML = 'Copy successful!'; $("#success").toast('show'); window.location.reload(); }, error: function(xhr) { document.getElementById("errorMesssage").innerHTML = 'Copy failed: ' + (xhr.responseText || 'Unknown error'); $('#ErrorModal').modal('show'); } }); }); } $(document).ready(function() { $('#editVisitLimitModal form').on('submit', function(e) { e.preventDefault(); return false; }); $('#ErrorModalCloseBtn, #ErrorClose').on('click', function(e) { if (e) e.preventDefault(); $('#ErrorModal').modal('hide'); return false; }); $('#ErrorModal, #cocCfrmBoxModal').on('show.bs.modal', function() { if ($('#editVisitLimitModal').hasClass('show')) { var $this = $(this); $('#editVisitLimitModal').css('z-index', '1040'); $this.css('z-index', '1060'); setTimeout(function() { $('.modal-backdrop').last().css('z-index', '1055'); }, 0); } }).on('hidden.bs.modal', function() { if ($('#editVisitLimitModal').hasClass('show')) { $('#editVisitLimitModal').css('z-index', ''); } }); }); function toggleSelectRow(index) { const checkbox = document.getElementById(`selectRowChk_${index}`); if (!checkbox) return; const accordionItem = checkbox.closest('.accordion-item'); let benCatName = '', cocSeries = '', state = '', standard = ''; if (accordionItem) { const strong = accordionItem.querySelector('strong'); if (strong) { benCatName = strong.childNodes[0]?.textContent.replace(/\s*\(\d+\)$/, '').trim() || ''; } const small = accordionItem.querySelector('small.text-muted'); if (small) { // Expected format: " - cocSeries - state - standard" const parts = small.textContent.split(' -').map(s => s.trim()); cocSeries = parts[1] || ''; state = parts[2] || ''; standard = parts[3] || ''; } } const maxId = checkbox.value; // Collect all checked checkboxes' cocSeries const checkedBoxes = Array.from(document.querySelectorAll('input[name="selectedRows"]:checked')); const cocSeriesSet = new Set(); checkedBoxes.forEach(cb => { const accItem = cb.closest('.accordion-item'); if (accItem) { const small = accItem.querySelector('small.text-muted'); if (small) { const parts = small.textContent.split('-').map(s => s.trim()); if (parts[1]) cocSeriesSet.add(parts[1]); } } }); if (cocSeriesSet.size > 1) { document.getElementById("ErrorMesssage").innerHTML = "Selected records have different COC Series. Please select records with the same COC Series."; $("#ErrorModal").modal("toggle"); checkbox.checked = false; return; } if (benCatName === '' || state === '' || standard === '' || cocSeries === '') { document.getElementById("ErrorMesssage").innerHTML = "Required fields are missing. Please check Benefit category, state, standard and COC Series."; $("#ErrorModal").modal("toggle"); checkbox.checked = false; return; } // Enable bulk update button if role is correct and checkbox is checked or unchecked const roleId = Number(document.getElementById('ifpRoleId').value); document.getElementById('bulkUpdate').disabled = !(checkedBoxes.length > 0 && roleId === 8); // Enable bulk delete button if role is correct and checkbox is checked or unchecked document.getElementById('bulkDelete').disabled = !(checkedBoxes.length > 0 && roleId === 8); // Update Bulk Update and Bulk Delete count before request, based on checked checkboxes const checkedCount = document.querySelectorAll('input[name="selectedRows"]:checked').length; const countSpan = document.getElementById('bulkUpdateCount'); const countDeleteSpan = document.getElementById('bulkDeleteCount'); const selectedCountSpan = document.getElementById('selectedCount'); if (checkedCount > 0) { countSpan.textContent = checkedCount; countDeleteSpan.textContent = checkedCount; countSpan.style.display = ''; countDeleteSpan.style.display = ''; } else { countSpan.textContent = 0; countDeleteSpan.textContent = 0; countSpan.style.display = 'none'; countDeleteSpan.style.display = 'none'; } if (selectedCountSpan) { if (checkedCount === 1) { selectedCountSpan.textContent = '1 selected item'; } else if (checkedCount > 1) { selectedCountSpan.textContent = checkedCount + ' selected items'; } else { selectedCountSpan.textContent = ''; } } // Call API to get related maxIds request = ({ maxId: maxId, benCatName: benCatName, state: state, cocSeries: cocSeries, standard: standard }) if (checkbox.checked) { $.ajax({ type: "POST", contentType: "application/json", url: "findRelatedMaxIds", data: JSON.stringify(request), dataType: 'json', success: function (maxCollection) { // Add the response to window.selectedBulkMax, accumulating if already present if (!window.selectedBulkMax || !Array.isArray(window.selectedBulkMax)) { window.selectedBulkMax = []; } // Add new items, avoiding duplicates by maxId maxCollection.forEach(function (item) { if (!window.selectedBulkMax.some(existing => existing.maxId === item.maxId)) { window.selectedBulkMax.push(item); } }); }, error: function (xhr) { console.log("error", xhr); alert("Something went wrong while saving plans, please try again..!"); } }); } else { // If unchecked, remove related maxIds from window.selectedBulkMax and update bulkUpdate button const maxId = checkbox.value; if (window.selectedBulkMax && Array.isArray(window.selectedBulkMax)) { // Remove all related maxIds returned by the API from selectedBulkMax $.ajax({ type: "POST", contentType: "application/json", url: "findRelatedMaxIds", data: JSON.stringify(request), dataType: 'json', success: function (maxCollection) { const idsToRemove = maxCollection.map(item => item.maxId); window.selectedBulkMax = window.selectedBulkMax.filter(item => !idsToRemove.includes(item.maxId)); }, error: function (xhr) { console.log("error", xhr); alert("Something went wrong while saving plans, please try again..!"); } }); } } } function clearBulkUpdate() { for (let i = 1; i <= 4; i++) { // Reset the select to default const select = document.getElementById(`bulkField_${i}`); if (select) select.value = ""; // Reset the value input const container = document.getElementById(`bulkValueInput_${i}`); if (container) { container.innerHTML = `<input class="form-control" type="text" disabled>`; } } document.getElementById('applyBulkUpdate').disabled = true; } function createDropdownFromArray(options) { return ` <select class="form-control" onclick="validateApplyButton()"> <option value="">Select...</option> ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')} </select> `; } function handleBulkFieldChange(select, inputContainerId) { const field = select.value; const container = document.getElementById(inputContainerId); let inputHtml = ''; switch (field) { case 'Visible': inputHtml = createDropdownFromArray(BULK_OPTIONS.visible); break; case 'Cross Applies': inputHtml = createDropdownFromArray(BULK_OPTIONS.crossApplies); break; case 'Max Type': inputHtml = createDropdownFromArray(BULK_OPTIONS.maxTypes); break; case 'Freq Type': inputHtml = createDropdownFromArray(BULK_OPTIONS.freqTypes); break; case 'Max Value': inputHtml = `<input class="form-control" type="number" min="1" max="999999" oninput="validity.valid||(value='');validateApplyButton();">`; break; case 'Freq Value': inputHtml = `<input class="form-control" type="number" min="1" max="9999" oninput="validity.valid||(value='');validateApplyButton();">`; break; default: inputHtml = `<input class="form-control" type="text" disabled>`; } container.innerHTML = inputHtml; validateApplyButton(); } function validateApplyButton() { let isValid = false; for (let i = 1; i <= 4; i++) { const field = document.getElementById(`bulkField_${i}`)?.value; const valueInput = document .getElementById(`bulkValueInput_${i}`) ?.querySelector('input, select'); if (field && valueInput && valueInput.value) { isValid = true; break; } } document.getElementById("applyBulkUpdate").disabled = !isValid; } function applyBulkUpdate() { // Use the related maxIds list if available, else fallback to checked checkboxes const selectedMax = window.selectedBulkMax; const updates = []; for (let i = 1; i <= 4; i++) { const field = document.getElementById(`bulkField_${i}`)?.value; const valueInput = document .getElementById(`bulkValueInput_${i}`) ?.querySelector('input, select'); if (field && valueInput && valueInput.value) { updates.push({ field: field, value: valueInput.value }); } } if (updates.length === 0) return; const request = { maxCollection: selectedMax, updates: updates }; if (request.maxCollection && request.maxCollection.length > 0) { $.ajax({ type: "POST", contentType: "application/json", url: "bulkUpdateMaximum", data: JSON.stringify(request), dataType: 'json', success: function (res) { if (res.message != null) { document.getElementById("successResult").innerHTML = res.message; $("#sucessBoxNewMaximumModal").modal("show"); } }, error: function (xhr) { console.log("error", xhr); alert("Something went wrong while saving plans, please try again..!"); } }); } } const NOTES_MAX_LEN = 2000; let currentNotesContext = null; let currentNotesCache = []; function openNotesList(benCatName, cocSeries, state, standard) { currentNotesContext = { benCatName: benCatName || "", cocSeries: cocSeries || "", state: state || "", standard: standard || "" }; showAndHide(); $.ajax({ url: "maxManagement/get-notes", type: "GET", contentType: "application/json", dataType: "json", data: currentNotesContext, success: function(res) { showAndHide(); const notesArr = Array.isArray(res) ? res : (res?.notes ?? []); if (!notesArr || notesArr.length === 0) { openNotesModal(currentNotesContext.benCatName, currentNotesContext.cocSeries, currentNotesContext.state, currentNotesContext.standard); return; } currentNotesCache = notesArr; renderNotesList(notesArr); $("#notesListModal").modal("show"); }, error: function(xhr) { showAndHide(); document.getElementById("ErrorMesssage").innerHTML = "Unable to load notes. Please try again."; $("#ErrorModal").modal("toggle"); openNotesModal(benCatName, cocSeries, state, standard); } }); } function openAddNotesModal() { $("#notesListModal").modal("hide"); if (!currentNotesContext) { return; } openNotesModal(currentNotesContext.benCatName, currentNotesContext.cocSeries, currentNotesContext.state, currentNotesContext.standard); } function renderNotesList(notesArr) { const tbody = document.getElementById("notesListTbody"); const empty = document.getElementById("notesListEmpty"); const table = document.getElementById("notesListTable"); if (!tbody) return; tbody.innerHTML = ""; if (!notesArr || notesArr.length === 0) { if (empty) empty.style.display = ""; if (table) table.style.display = "none"; return; } if (empty) empty.style.display = "none"; if (table) table.style.display = ""; const sorted = notesArr.slice().reverse(); sorted.forEach(function(note) { const noteId = note.id || note.noteId || note._id || ""; const text = note.noteDescription || note.description || note.text || ""; const createdBy = note.createdBy || note.createdUser || note.createdByName || ""; const createdOn = note.createdOn || note.createdDate || note.createdAt || ""; const modifiedBy = note.modifiedBy || note.updatedBy || note.lastModifiedBy || ""; const modifiedOn = note.modifiedOn || note.updatedOn || note.lastModifiedOn || note.updatedAt || ""; const tr = document.createElement("tr"); tr.innerHTML = ` <td class="notes-cell" title="${escapeHtml(text)}"> ${escapeHtml(text)} </td> <td>${escapeHtml(createdBy)}</td> <td>${escapeHtml(createdOn)}</td> <td>${escapeHtml(modifiedBy)}</td> <td>${escapeHtml(modifiedOn)}</td> <td> <div class="d-flex gap-2"> <button type="button" class="btn btn-outline-primary btn-sm note-action-btn" title="Edit" onclick="editNoteFromList('${escapeAttr(noteId)}')"> <i class="fas fa-edit"></i> </button> <button type="button" class="btn btn-outline-danger btn-sm note-action-btn" title="Delete" onclick="deleteNoteFromList('${escapeAttr(noteId)}')"> <i class="fas fa-trash"></i> </button> </div> </td> `; tbody.appendChild(tr); }); } function escapeHtml(str) { return String(str || "") .replace(/&/g, "&amp;") .replace(/</g, "&lt;") .replace(/>/g, "&gt;") .replace(/"/g, "&quot;") .replace(/'/g, "&#039;"); } function escapeAttr(str) { return escapeHtml(str).replace(/`/g, "&#096;"); } function openNotesModal(benCatName, cocSeries, state, standard, noteObj) { $("#notesBenCatName").val(benCatName || ""); $("#notesCocSeries").val(cocSeries || ""); $("#notesState").val(state || ""); $("#notesStandard").val(standard || ""); const isEdit = !!noteObj; const noteId = isEdit ? (noteObj.id || noteObj.noteId || noteObj._id || "") : ""; const noteText = isEdit ? (noteObj.noteDescription || noteObj.description || noteObj.text || "") : ""; $("#notesId").val(noteId); $("#notesText").val(noteText); $("#notesCount").text(String((noteText || "").length)); $("#notesError").hide(); $("#notesText").removeClass("is-invalid"); $("#notesModalLabel").text(isEdit ? "Edit Note" : "Add Note"); $("#saveNotesBtn").prop("disabled", (noteText || "").trim().length === 0); $("#notesModal").modal("show"); } function notesInputChange() { const text = $("#notesText").val() || ""; const len = text.length; $("#notesCount").text(len); if (len > NOTES_MAX_LEN) { $("#notesError").show().text("Text exceeds maximum length"); $("#notesText").addClass("is-invalid"); $("#saveNotesBtn").prop("disabled", true); return; } $("#notesError").hide(); $("#notesText").removeClass("is-invalid"); $("#saveNotesBtn").prop("disabled", text.trim().length === 0); } function saveNotes() { const noteText = ($("#notesText").val() || "").trim(); if (!noteText) { $("#saveNotesBtn").prop("disabled", true); return; } if (noteText.length > NOTES_MAX_LEN) { $("#notesError").show().text("Text exceeds maximum length"); $("#notesText").addClass("is-invalid"); $("#saveNotesBtn").prop("disabled", true); return; } const payload = { benCatName: $("#notesBenCatName").val(), cocSeries: $("#notesCocSeries").val(), state: $("#notesState").val(), standard: $("#notesStandard").val(), noteDescription: noteText }; $.ajax({ type: "POST", contentType: "application/json", url: "maxManagement/save-notes", data: JSON.stringify(payload), dataType: "json", success: function (res) { if (res.success) { $("#notesModal").modal("hide"); document.getElementById("successResult").innerHTML = 'Note added successfully.'; $("#sucessBoxNewMaximumModal").modal("toggle"); } else { $("#notesModal").modal("hide"); document.getElementById("ErrorMesssage").innerHTML = 'Failed to save note'; $("#ErrorModal").modal("toggle"); } }, error: function (xhr) { $("#notesModal").modal("hide"); let msg = "Something went wrong"; if (xhr.status === 400) { msg = xhr.responseJSON?.message || "Invalid input"; } else if (xhr.status === 401) { msg = "Session expired. Please login again."; } else if (xhr.status === 500) { msg = "Server error. Try again later."; } document.getElementById("ErrorMesssage").innerHTML = msg; $("#ErrorModal").modal("toggle"); } }); } function validateStatusSequence(newStatus) { const statusSequence = ["In Progress", "Ready for Review", "Final", "Updated"]; if (!originalStatus || originalStatus.trim() === "" || originalStatus.trim() === " ") { return newStatus === "In Progress"; } const currentIndex = statusSequence.indexOf(originalStatus); const newIndex = statusSequence.indexOf(newStatus); if (currentIndex === -1 || newIndex === -1) { return false; } return newIndex === currentIndex || newIndex === currentIndex + 1; } function onModalCocChange(cocSeriesSelectId, standardSelectId) { let cocSeries = $('#' + cocSeriesSelectId).val(); cocSeries = (cocSeries && cocSeries.trim() !== "") ? cocSeries.trim() : ""; $.ajax({ url: "maxManagement/product-family?cocSeries=" + cocSeries, type: 'GET', success: function(res) { let $standard = $("#" + standardSelectId); $standard.empty(); $standard.append('<option value="">Select Product Family</option>'); if (res && res.length > 0) { for (let i = 0; i < res.length; i++) { let option = document.createElement("option"); option.value = res[i]; option.text = res[i]; $standard.append(option); } } }, error: function(xhr) { console.error("Error loading product families:", xhr); } }); }
