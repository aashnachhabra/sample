
- name: Fetch Changed Files
  id: changed-files
  run: |
    # Get the PR number
    PR_NUMBER="${{ github.event.pull_request.number }}"

    # Get the list of changed files for the PR
    FILES=$(gh pr view $PR_NUMBER --json files --jq '.files[] | {path: .path, additions: .additions, deletions: .deletions}')

    # Add status (added, modified, deleted) to each file and only keep path and status
    REPO_URL="https://github.com/uhc-tech-employer-individual/altus_genie/blob/main"
    ABSOLUTE_PATHS=$(echo "$FILES" | jq -c --arg REPO_URL "$REPO_URL" '
      map(
        .status = 
          (if .additions > 0 and .deletions == 0 then "added"
           elif .additions == 0 and .deletions > 0 then "deleted"
           elif .additions > 0 or .deletions > 0 then "modified"
           else "unknown" end) |
        {path: ($REPO_URL + "/" + .path), status: .status}
      )
    ')

    # Output the JSON file
    echo "${ABSOLUTE_PATHS}" > changed_files.json
    echo "::set-output name=files::${ABSOLUTE_PATHS}"

    # Debug output
    echo "Changed files JSON:"
    cat changed_files.json
